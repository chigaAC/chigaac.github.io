<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Markdownã‚¨ãƒ‡ã‚£ã‚¿</title>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    textarea { width: 100%; height: 200px; }
    #preview { border: 1px solid #ccc; padding: 10px; }
  </style>
</head>
<body>
  <h2>ğŸ“ Markdownç·¨é›†</h2>
  <button onclick="save()">ğŸ’¾ ä¿å­˜</button>
  <textarea id="editor"></textarea>
  <h3>ğŸ“„ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
  <div id="preview"></div>

  <script>
    const params = new URLSearchParams(location.search);
    const fileId = params.get("id");
    const token = localStorage.getItem("accessToken");

    const editor = document.getElementById("editor");
    const preview = document.getElementById("preview");

    async function loadFile() {
      const res = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      const text = await res.text();
      editor.value = text;
      updatePreview();
    }

    function updatePreview() {
      preview.innerHTML = marked.parse(editor.value);
    }

    editor.addEventListener("input", updatePreview);

    async function save() {
      const content = editor.value;
      const metadata = new Blob([content], { type: "text/markdown" });

      const form = new FormData();
      form.append("file", metadata);

      const res = await fetch(
        `https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`,
        {
          method: "PATCH",
          headers: { Authorization: `Bearer ${token}` },
          body: content
        }
      );

      if (res.ok) {
        alert("âœ… ä¿å­˜ã—ã¾ã—ãŸï¼");
        // map.json ã®æ›´æ–°å‡¦ç†ã‚’ã“ã“ã«è¿½åŠ äºˆå®š
      } else {
        alert("âŒ ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ");
      }
    }

    loadFile();
  </script>
</body>
</html>
