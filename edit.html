<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Markdownã‚¨ãƒ‡ã‚£ã‚¿</title>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    textarea { width: 100%; height: 200px; }
    #preview { border: 1px solid #ccc; padding: 10px; }
  </style>
</head>
<body>
  <h2 id="projectTitle">ğŸ“ Markdownç·¨é›†</h2>
  <button onclick="save()">ğŸ’¾ ä¿å­˜</button>
  <textarea id="editor"></textarea>
  <h3>ğŸ“„ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
  <div id="preview"></div>

  <script>
    const params = new URLSearchParams(location.search);
    const fileId = params.get("id");       // ç·¨é›†å¯¾è±¡ã®ãƒ¡ãƒ¢ãƒ•ã‚¡ã‚¤ãƒ«ID
    const mapFileId = params.get("project") || localStorage.getItem("mapFileId");
    const token = localStorage.getItem("accessToken");

    const editor = document.getElementById("editor");
    const preview = document.getElementById("preview");
    const projectTitle = document.getElementById("projectTitle");

    // --- map.jsonã‚’å–å¾— ---
    async function fetchMapJson() {
      if (!mapFileId) return null;
      const res = await fetch(`https://www.googleapis.com/drive/v3/files/${mapFileId}?alt=media`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      return await res.json();
    }

    // --- è¦ªãƒ•ã‚©ãƒ«ãƒ€åã‚’å–å¾— ---
    async function fetchProjectName() {
      if (!mapFileId) return;
      const fileRes = await fetch(`https://www.googleapis.com/drive/v3/files/${mapFileId}?fields=parents`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      const fileData = await fileRes.json();
      const parentId = fileData.parents && fileData.parents[0];
      if (parentId) {
        const parentRes = await fetch(`https://www.googleapis.com/drive/v3/files/${parentId}?fields=name`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        const parentData = await parentRes.json();
        return parentData.name;
      }
      return "(ä¸æ˜ãªãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ)";
    }

    // --- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’è¡¨ç¤º ---
    async function updateProjectTitle() {
      const projectName = await fetchProjectName();
      projectTitle.textContent = `ğŸ“ [${projectName}] Markdownç·¨é›†`;
    }

    // --- ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ ---
    async function loadFile() {
      if (!fileId) {
        alert("âŒ ãƒ¡ãƒ¢IDãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“");
        return;
      }
      const res = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      if (!res.ok) {
        alert("âŒ ãƒ¡ãƒ¢ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ");
        return;
      }
      const text = await res.text();
      editor.value = text;
      updatePreview();
    }

    // --- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–° ---
    function updatePreview() {
      preview.innerHTML = marked.parse(editor.value);
    }
    editor.addEventListener("input", updatePreview);

    // --- ä¿å­˜å‡¦ç† ---
    async function save() {
      if (!fileId) {
        alert("âŒ ãƒ¡ãƒ¢IDãŒä¸æ˜ã§ã™");
        return;
      }
      const content = editor.value;

      const res = await fetch(
        `https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`,
        {
          method: "PATCH",
          headers: { Authorization: `Bearer ${token}` },
          body: content
        }
      );

      if (res.ok) {
        alert("âœ… ä¿å­˜ã—ã¾ã—ãŸï¼");
        await updateMapJsonTimestamp();
      } else {
        alert("âŒ ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ");
      }
    }

    // --- map.jsonã®æ›´æ–°ï¼ˆç·¨é›†æ—¥æ™‚ã‚’è¿½è¨˜ï¼‰ ---
    async function updateMapJsonTimestamp() {
      if (!mapFileId) return;
      const map = await fetchMapJson();
      if (!map || !map.files) return;

      const target = map.files.find(f => f.id === fileId);
      if (target) {
        target.updated = new Date().toISOString();
      }

      const form = new FormData();
      form.append("metadata", new Blob([JSON.stringify({ name: "map.json", mimeType: "application/json" })], { type: "application/json" }));
      form.append("file", new Blob([JSON.stringify(map, null, 2)], { type: "application/json" }));

      const updateRes = await fetch(
        `https://www.googleapis.com/upload/drive/v3/files/${mapFileId}?uploadType=multipart`,
        {
          method: "PATCH",
          headers: { Authorization: `Bearer ${token}` },
          body: form
        }
      );

      if (!updateRes.ok) {
        console.warn("âš ï¸ map.json ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ");
      }
    }

    // --- åˆæœŸãƒ­ãƒ¼ãƒ‰ ---
    updateProjectTitle();  // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåè¡¨ç¤º
    loadFile();
  </script>
</body>
</html>
