<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Google Drive ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ</title>
</head>
<body>
  <p id="TokenTimer">â€»ã“ã“ã«æ™‚è¨ˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
  <h2>ğŸ“ Google Drive ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ</h2>
  <button onclick="redirectLogin()">Googleã§ãƒ­ã‚°ã‚¤ãƒ³</button>

  <input type="text" id="projectName" placeholder="ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’å…¥åŠ›" /><br><br>

  <button onclick="listFolders()">ğŸ“‚ è¦ªãƒ•ã‚©ãƒ«ãƒ€é¸æŠ</button>
  <div id="folderList">(ãƒ•ã‚©ãƒ«ãƒ€ä¸€è¦§ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™)</div><br>

<button onclick="startProjectCreation()">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ</button>
  <pre id="log">(ã“ã“ã«ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™)</pre>

  <script>
    const token = localStorage.getItem("accessToken");
const expiresAt = parseInt(localStorage.getItem("tokenExpiresAt") || "0");
    function set2fig(num) {
Â Â Â // æ¡æ•°ãŒ1æ¡ã ã£ãŸã‚‰å…ˆé ­ã«0ã‚’åŠ ãˆã¦2æ¡ã«èª¿æ•´ã™ã‚‹
Â Â Â var ret;
Â Â Â if( num < 10 ) { ret = "0" + num; }
Â Â Â else { ret = num; }
Â Â Â return ret;
}
function showClock() {/*
  if (token && parseInt(Date.now()) < expiresAt) {
  Â Â Â var nowTime = new Date();
     nowTime=parseInt(nowTime.toString())-expiresAt;*/
Â Â Â /*var nowHour = set2fig( expiresAt.getHours()-nowTime.getHours() );
Â Â Â var nowMinÂ  = set2fig( expiresAt.getMinutes()-nowTime.getMinutes() );
Â Â Â var nowSecÂ  = set2fig( expiresAt.getSeconds()-nowTime.getSeconds() );
Â Â Â var msg = "å†ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã«ãªã‚‹ã¾ã§å¾Œ" + nowHour + ":" + nowMin + ":" + nowSec + " ã§ã™ã€‚";*/
    /*
Â Â Â var msg = "å†ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã«ãªã‚‹ã¾ã§å¾Œ" + nowTime+ " ã§ã™ã€‚"+expiresAt;
} else {
  // ãƒˆãƒ¼ã‚¯ãƒ³æœŸé™åˆ‡ã‚Œ â†’ å†ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦
    var msg="ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚"+expiresAt;
}*/
Â Â /*Â var nowTime = new Date();
Â Â Â var nowHour = set2fig( nowTime.getHours() );
Â Â Â var nowMinÂ  = set2fig( nowTime.getMinutes() );
Â Â Â var nowSecÂ  = set2fig( nowTime.getSeconds() );
Â Â Â var msg = "ç¾åœ¨æ™‚åˆ»ã¯ã€" + nowHour + ":" + nowMin + ":" + nowSec + " ã§ã™ã€‚";*/
  
Â Â Â document.getElementById("TokenTimer").innerHTML = localStorage.getItem("tokenExpiresAt");
}
setInterval('showClock()',1000);

    const clientId = "295167116096-sva04gs0vtr6hvof2r1cfdtlqre4ohpb.apps.googleusercontent.com";
    const redirectUri = "https://chigaac.github.io/callback.html";
    const scope = "https://www.googleapis.com/auth/drive.file";

    let selectedParentId = null;
    const log = msg => document.getElementById("log").textContent += `\n${msg}`;
/*
    function redirectSignIn() {
      const projectName = document.getElementById("projectName").value.trim();
      if (!projectName) return log("âŒ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
      if (!selectedParentId) return log("âŒ è¦ªãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠã—ã¦ãã ã•ã„");

      localStorage.setItem("pendingProjectName", projectName);
      localStorage.setItem("pendingParentId", selectedParentId);

      const params = new URLSearchParams({
        client_id: clientId,
        redirect_uri: redirectUri,
        response_type: "token",
        scope: scope,
        include_granted_scopes: "true"
      });
      location.href = `https://accounts.google.com/o/oauth2/v2/auth?${params}`;
    }*/
function redirectLogin() {
  const params = new URLSearchParams({
    client_id: clientId,
    redirect_uri: redirectUri,
    response_type: "token",
    scope: scope,
    include_granted_scopes: "true"
  });
  location.href = `https://accounts.google.com/o/oauth2/v2/auth?${params}`;
  localStorage.setItem("accessToken", token);
localStorage.setItem("tokenExpiresAt", (Date.now() + expires_in * 1000).toString());
}
    function startProjectCreation() {
  const token = localStorage.getItem("accessToken");
  if (!token) return log("âŒ ãƒˆãƒ¼ã‚¯ãƒ³ãŒæœªå–å¾—ã§ã™ï¼ˆGoogleãƒ­ã‚°ã‚¤ãƒ³å¾Œã«å†åº¦ãŠè©¦ã—ãã ã•ã„ï¼‰");

  const projectName = document.getElementById("projectName").value.trim();
  if (!projectName) return log("âŒ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

  if (!selectedParentId) return log("âŒ è¦ªãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠã—ã¦ãã ã•ã„");

  localStorage.setItem("pendingProjectName", projectName);
  localStorage.setItem("pendingParentId", selectedParentId);

  // ä½œæˆå®Ÿè¡Œã¯ token å–å¾—æ¸ˆã¿ãªã®ã§ createProject ã‚’ç›´æ¥å‘¼ã¹ã‚‹
  createProject(projectName, selectedParentId, token);
}
    async function listFolders() {
      const token = localStorage.getItem("accessToken");
      if (!token) {
        log("âŒ ãƒˆãƒ¼ã‚¯ãƒ³ãŒæœªå–å¾—ã§ã™ï¼ˆGoogleãƒ­ã‚°ã‚¤ãƒ³å¾Œã«å†åº¦ãŠè©¦ã—ãã ã•ã„ï¼‰");
        return;
      }

      const res = await fetch("https://www.googleapis.com/drive/v3/files?q=mimeType='application/vnd.google-apps.folder' and trashed=false&fields=files(id,name)", {
        headers: { Authorization: `Bearer ${token}` }
      });

      const result = await res.json();
      const div = document.getElementById("folderList");
      div.innerHTML = "";
      result.files.forEach(f => {
        const btn = document.createElement("button");
        btn.textContent = f.name;
        btn.onclick = () => {
          selectedParentId = f.id;
          log(`ğŸ“Œ è¦ªãƒ•ã‚©ãƒ«ãƒ€é¸æŠ: ${f.name}`);
        };
        div.appendChild(btn);
        div.appendChild(document.createElement("br"));
      });
    }
/*
    window.onload = () => {
      const token = localStorage.getItem("accessToken");
      const projectName = localStorage.getItem("pendingProjectName");
      const parentId = localStorage.getItem("pendingParentId");
      if (token && projectName && parentId) {
        createProject(projectName, parentId, token);
        localStorage.removeItem("accessToken");
        localStorage.removeItem("pendingProjectName");
        localStorage.removeItem("pendingParentId");
      }
    };
*/
    async function createProject(name, parentId, token) {
      log(`ğŸ“ '${name}' ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆä¸­...`);

      const res1 = await fetch("https://www.googleapis.com/drive/v3/files", {
        method: "POST",
        headers: {
          Authorization: `Bearer ${token}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          name,
          mimeType: "application/vnd.google-apps.folder",
          parents: [parentId]
        })
      });

      const project = await res1.json();
      const projectId = project.id;

      async function createSub(name) {
        const res = await fetch("https://www.googleapis.com/drive/v3/files", {
          method: "POST",
          headers: {
            Authorization: `Bearer ${token}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            name,
            mimeType: "application/vnd.google-apps.folder",
            parents: [projectId]
          })
        });
        return (await res.json()).id;
      }

      const memoId = await createSub("ãƒ¡ãƒ¢");
      const embedId = await createSub("åŸ‹ã‚è¾¼ã¿ãƒ•ã‚¡ã‚¤ãƒ«");

      const map = {
        projectName: name,
        folders: { memo: memoId, embed: embedId },
        files: []
      };

      const metadata = {
        name: "map.json",
        mimeType: "application/json",
        parents: [projectId]
      };

      const form = new FormData();
      form.append("metadata", new Blob([JSON.stringify(metadata)], { type: "application/json" }));
      form.append("file", new Blob([JSON.stringify(map, null, 2)], { type: "application/json" }));

      const upload = await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart", {
        method: "POST",
        headers: {
          Authorization: `Bearer ${token}`
        },
        body: form
      });

      if (upload.ok) {
        log("âœ… ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆå®Œäº†");
        const mapInfo = await upload.json();
        localStorage.setItem("accessToken", token);
        localStorage.setItem("mapFileId", mapInfo.id);
        window.location.href = "dashboard.html";
      } else {
        log("âŒ map.json ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—");
      }
    }
  </script>
</body>
</html>
