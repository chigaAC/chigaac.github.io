<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>çµ±æ‹¬ãƒšãƒ¼ã‚¸</title>
  <style>
    body { font-family: sans-serif; padding: 1em; }
    #header { position: sticky; top: 0; background: white; padding: 0.5em; border-bottom: 1px solid #ccc; }
    #fileList a { display: block; margin: 0.5em 0; }
  </style>
</head>
<body>
  <div id="header">
    <button onclick="createMemo()">ğŸ“ ãƒ¡ãƒ¢æ–°è¦ä½œæˆ</button>
  </div>

  <h3>ğŸ“„ ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§</h3>
  <div id="fileList">(èª­ã¿è¾¼ã¿ä¸­...)</div>

  <script>
    const token = localStorage.getItem("accessToken");
    const mapFileId = localStorage.getItem("mapFileId");

    async function fetchMapJson() {
      const res = await fetch(`https://www.googleapis.com/drive/v3/files/${mapFileId}?alt=media`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      return await res.json();
    }

    async function listFiles(folderId) {
      const res = await fetch(`https://www.googleapis.com/drive/v3/files?q='${folderId}'+in+parents+and+trashed=false`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      const data = await res.json();
      return data.files || [];
    }

    async function displayFiles() {
      const listEl = document.getElementById("fileList");
      try {
        const map = await fetchMapJson();
        const memoFiles = await listFiles(map.folders.memo);
        const embedFiles = await listFiles(map.folders.embed);

        listEl.innerHTML = "";

        listEl.innerHTML += "<strong>ğŸ—‚ ãƒ¡ãƒ¢:</strong><br/>";
        memoFiles.forEach(f => {
          const a = document.createElement("a");
          a.href = `https://drive.google.com/file/d/${f.id}/view`;
          a.textContent = f.name;
          a.target = "_blank";
          listEl.appendChild(a);
        });

        listEl.innerHTML += "<br/><strong>ğŸ–‡ åŸ‹ã‚è¾¼ã¿ãƒ•ã‚¡ã‚¤ãƒ«:</strong><br/>";
        embedFiles.forEach(f => {
          const a = document.createElement("a");
          a.href = `https://drive.google.com/file/d/${f.id}/view`;
          a.textContent = f.name;
          a.target = "_blank";
          listEl.appendChild(a);
        });

      } catch (e) {
        listEl.textContent = "âŒ ã‚¨ãƒ©ãƒ¼: map.jsonã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ";
        console.error(e);
      }
    }

    async function createMemo() {
      const map = await fetchMapJson();
      const fileName = `æ–°è¦ãƒ¡ãƒ¢_${Date.now()}.txt`;

      const metadata = {
        name: fileName,
        mimeType: "text/plain",
        parents: [map.folders.memo]
      };

      const form = new FormData();
      form.append("metadata", new Blob([JSON.stringify(metadata)], { type: "application/json" }));
      form.append("file", new Blob([""], { type: "text/plain" }));

      const res = await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart", {
        method: "POST",
        headers: { Authorization: `Bearer ${token}` },
        body: form
      });

      if (res.ok) {
        const newFile = await res.json();
        window.open(`edit.html?id=${newFile.id}`, "_blank");
      } else {
        alert("âŒ ãƒ¡ãƒ¢ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ");
      }
    }

    displayFiles();
  </script>
</body>
</html>
