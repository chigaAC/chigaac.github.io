<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>çµ±æ‹¬ãƒšãƒ¼ã‚¸</title>
  <style>
    body { font-family: sans-serif; padding: 1em; }
    #header { position: sticky; top: 0; background: white; padding: 0.5em; border-bottom: 1px solid #ccc; }
    #fileList a { display: block; margin: 0.5em 0; }
  </style>
</head>
<body>
  <div id="header">
    <button onclick="createMemo()">ğŸ“ ãƒ¡ãƒ¢æ–°è¦ä½œæˆ</button>
    <select id="projectSelect" onchange="selectProject(this.value)">
  <option value="">-- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠ --</option>
</select>
  </div>
  
<div id="dropZone" style="border:2px dashed #888; padding:2em; text-align:center;">
  ã“ã“ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ï¼ˆã¾ãŸã¯ä¸‹ã®ãƒœã‚¿ãƒ³ã§é¸æŠï¼‰
</div>
<input type="file" id="filePicker" multiple style="margin-top:10px;" />
<ul id="filePreview"></ul>
<button onclick="uploadAll()">å®Œäº†ã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
  
  <h3>ğŸ“„ ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§</h3>
  <div id="fileList">(èª­ã¿è¾¼ã¿ä¸­...)</div>

  <script>
    const token = localStorage.getItem("accessToken");
    const mapFileId = localStorage.getItem("mapFileId");

    async function fetchMapJson() {
      const res = await fetch(`https://www.googleapis.com/drive/v3/files/${mapFileId}?alt=media`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      return await res.json();
    }

    async function listFiles(folderId) {
      const res = await fetch(`https://www.googleapis.com/drive/v3/files?q='${folderId}'+in+parents+and+trashed=false`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      const data = await res.json();
      return data.files || [];
    }

    async function displayFiles() {
      const listEl = document.getElementById("fileList");
      try {
        const map = await fetchMapJson();
        const memoFiles = await listFiles(map.folders.memo);
        const embedFiles = await listFiles(map.folders.embed);

        listEl.innerHTML = "";

        listEl.innerHTML += "<strong>ğŸ—‚ ãƒ¡ãƒ¢:</strong><br/>";
        memoFiles.forEach(f => {
          const a = document.createElement("a");
          a.href = `https://drive.google.com/file/d/${f.id}/view`;
          a.textContent = f.name;
          a.target = "_blank";
          listEl.appendChild(a);
        });

        listEl.innerHTML += "<br/><strong>ğŸ–‡ åŸ‹ã‚è¾¼ã¿ãƒ•ã‚¡ã‚¤ãƒ«:</strong><br/>";
        embedFiles.forEach(f => {
          const a = document.createElement("a");
          a.href = `https://drive.google.com/file/d/${f.id}/view`;
          a.textContent = f.name;
          a.target = "_blank";
          listEl.appendChild(a);
        });

      } catch (e) {
        listEl.textContent = "âŒ ã‚¨ãƒ©ãƒ¼: map.jsonã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ";
        console.error(e);
      }
    }
    async function createMemo() {
  const token = localStorage.getItem("accessToken");
  if (!token) {
    alert("âŒ ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ç›´ã—ã¦ãã ã•ã„ã€‚");
    return;
  }

  const map = await fetchMapJson();
  const fileName = `æ–°è¦ãƒ¡ãƒ¢_${Date.now()}.md`;
  const metadata = {
    name: fileName,
    mimeType: "text/markdown",
    parents: [map.folders.memo]
  };

  const form = new FormData();
  form.append("metadata", new Blob([JSON.stringify(metadata)], { type: "application/json" }));
  form.append("file", new Blob([""], { type: "text/markdown" }));

  const res = await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart", {
    method: "POST",
    headers: { Authorization: `Bearer ${token}` },
    body: form
  });

  if (!res.ok) {
    alert("âŒ ãƒ¡ãƒ¢ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ");
    return;
  }

  const newFile = await res.json();

  // map.json ã«è¿½è¨˜
  map.files.push({
    id: newFile.id,
    name: fileName,
    path: ["memo"],
    as: "memo",
    created: new Date().toISOString()
  });

  // map.json ã‚’ Drive ä¸Šã§æ›´æ–°
  const metadata2 = {
    name: "map.json",
    mimeType: "application/json"
  };

  const mapFileId = localStorage.getItem("mapFileId");
  const form2 = new FormData();
  form2.append("metadata", new Blob([JSON.stringify(metadata2)], { type: "application/json" }));
  form2.append("file", new Blob([JSON.stringify(map, null, 2)], { type: "application/json" }));

  const updateRes = await fetch(`https://www.googleapis.com/upload/drive/v3/files/${mapFileId}?uploadType=multipart`, {
    method: "PATCH",
    headers: { Authorization: `Bearer ${token}` },
    body: form2
  });

  if (!updateRes.ok) {
    alert("âš ï¸ ãƒ¡ãƒ¢ã¯ä½œæˆã•ã‚Œã¾ã—ãŸãŒã€map.json ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ");
  }

  // ãƒ¡ãƒ¢ç·¨é›†ãƒšãƒ¼ã‚¸ã¸é·ç§»
  window.open(`edit.html?id=${newFile.id}`, "_blank");
}

    //ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰(ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—)
let pendingFiles = []; // ãƒ‰ãƒ­ãƒƒãƒ— or é¸æŠã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿æŒ

const dropZone = document.getElementById("dropZone");
const filePicker = document.getElementById("filePicker");
const filePreview = document.getElementById("filePreview");

// ãƒ‰ãƒ©ãƒƒã‚°ã‚ªãƒ¼ãƒãƒ¼æ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ«å¤‰æ›´
dropZone.addEventListener("dragover", e => {
  e.preventDefault();
  dropZone.style.background = "#eef";
});
dropZone.addEventListener("dragleave", () => dropZone.style.background = "");

// ãƒ‰ãƒ­ãƒƒãƒ—å‡¦ç†
dropZone.addEventListener("drop", e => {
  e.preventDefault();
  dropZone.style.background = "";
  const files = Array.from(e.dataTransfer.files);
  pendingFiles.push(...files);
  refreshPreview();
});

// ãƒ•ã‚¡ã‚¤ãƒ«ãƒ”ãƒƒã‚«ãƒ¼ã‹ã‚‰é¸æŠ
filePicker.addEventListener("change", e => {
  const files = Array.from(e.target.files);
  pendingFiles.push(...files);
  refreshPreview();
  filePicker.value = ""; // å†é¸æŠç”¨ã«ã‚¯ãƒªã‚¢
});

// ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°
function refreshPreview() {
  filePreview.innerHTML = "";
  pendingFiles.forEach((file, index) => {
    const li = document.createElement("li");

    // ãƒ•ã‚¡ã‚¤ãƒ«å
    const nameSpan = document.createElement("span");
    nameSpan.textContent = `${file.name} (${Math.round(file.size / 1024)} KB) `;
    li.appendChild(nameSpan);
    // å‰Šé™¤ãƒœã‚¿ãƒ³
    const delBtn = document.createElement("button");
    delBtn.textContent = "å‰Šé™¤";
    delBtn.onclick = () => {
      pendingFiles.splice(index, 1);
      refreshPreview();
    };
    li.appendChild(delBtn);
    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢
    const preview = document.createElement("span");
    preview.style.margin = "0 10px";
    preview.style.display = "inline-block";

    if (file.type.startsWith("image/")) {
      // ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
      const img = document.createElement("img");
      img.style.maxWidth = "80px";
      img.style.maxHeight = "60px";
      img.style.objectFit = "cover";
      const reader = new FileReader();
      reader.onload = e => (img.src = e.target.result);
      reader.readAsDataURL(file);
      preview.appendChild(img);
    } else if (file.type.startsWith("video/")) {
      // å‹•ç”»ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆã‚µãƒ ãƒã‚¤ãƒ«ãªã—ã€ã‚¢ã‚¤ã‚³ãƒ³ã®ã¿ï¼‰
      preview.textContent = "ğŸï¸";
    } else if (file.type.startsWith("audio/")) {
      // éŸ³å£°ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆã‚¢ã‚¤ã‚³ãƒ³ï¼‰
      preview.textContent = "ğŸµ";
    } else if (file.type.startsWith("text/") || file.type === "application/json") {
      // ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®å†’é ­ã‚’ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
      const reader = new FileReader();
      reader.onload = e => {
        const content = e.target.result.slice(0, 20).replace(/\n/g, " ");
        preview.textContent = `ğŸ“ ${content}${content.length >= 20 ? "..." : ""}`;
      };
      reader.readAsText(file);
    } else {
      // ãã®ä»–ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆPDFã‚„ZIPãªã©ï¼‰
      preview.textContent = "ğŸ“„";
    }
    li.appendChild(preview);

    filePreview.appendChild(li);
  });
}

// ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†
async function uploadAll() {
  if (pendingFiles.length === 0) {
    alert("ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“");
    return;
  }

  const token = localStorage.getItem("accessToken");
  const map = await fetchMapJson();
  const uploadRoot = map.folders.data;

  // æ—¥æ™‚ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆ
  const now = new Date();
  const folderName = now.toISOString().replace(/[-:]/g, "").slice(0, 15).replace("T", "_");
  const folderId = await createFolder(folderName, uploadRoot, token);

  for (const file of pendingFiles) {
    await uploadFileToFolder(file, folderId, token);
  }

  alert("âœ… ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†ï¼");
  pendingFiles = [];
  refreshPreview();
}

async function createFolder(name, parentId, token) {
  const res = await fetch("https://www.googleapis.com/drive/v3/files", {
    method: "POST",
    headers: {
      Authorization: `Bearer ${token}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      name,
      mimeType: "application/vnd.google-apps.folder",
      parents: [parentId]
    })
  });
  return (await res.json()).id;
}

async function uploadFileToFolder(file, parentId, token) {
  const metadata = {
    name: file.name,
    parents: [parentId]
  };
  const form = new FormData();
  form.append("metadata", new Blob([JSON.stringify(metadata)], { type: "application/json" }));
  form.append("file", file);
  await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart", {
    method: "POST",
    headers: { Authorization: `Bearer ${token}` },
    body: form
  });
}
    //ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé¸æŠ
    async function listProjects() {
  const res = await fetch("https://www.googleapis.com/drive/v3/files?q=name='map.json' and trashed=false", {
    headers: { Authorization: `Bearer ${token}` }
  });
  const data = await res.json();

  const select = document.getElementById("projectSelect");
  select.innerHTML = "<option value=''>-- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠ --</option>";

  data.files.forEach(f => {
    const option = document.createElement("option");
    option.value = f.id;
    option.textContent = f.name + " (" + f.id + ")";
    select.appendChild(option);
  });
}

function selectProject(mapId) {
  if (!mapId) return;
  localStorage.setItem("mapFileId", mapId);
  displayFiles(); // é¸æŠã—ãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å†…å®¹ã‚’å†è¡¨ç¤º
}

// ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«ä¸€è¦§å–å¾—
listProjects();
    displayFiles();
  </script>
</body>
</html>
