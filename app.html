<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>çµ±åˆãƒ„ãƒ¼ãƒ«</title>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 0; }
    #header { background: #f0f0f0; padding: 0.5em; display: flex; gap: 1em; position: sticky; top: 0; }
    #header button { padding: 0.4em 1em; }
    .page { display: none; padding: 1em; }
    .page.active { display: block; }
    #dropZone { border: 2px dashed #888; padding: 2em; text-align: center; margin-top: 1em; }
    #filePreview li { margin: 0.3em 0; list-style: none; }
    #filePreview img { vertical-align: middle; }
    button { margin-left: 0.5em; }
    textarea { width: 100%; height: 200px; }
    #preview { border: 1px solid #ccc; padding: 10px; margin-top: 10px; }
  </style>
</head>
<body>
  <div id="header">
    <button onclick="showPage('index')">Index</button>
    <button onclick="showPage('dashboard')">Dashboard</button>
    <button onclick="showPage('edit')">Edit</button>
  </div>

  <!-- Index Page -->
  <div id="page-index" class="page active">
    <h2>ğŸ“ Google Drive ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ</h2>
    <button onclick="storageClear()">ã‚¯ãƒªã‚¢</button>
    <p id="loginStatus">ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹</p>
    <button onclick="redirectLogin()">Googleã§ãƒ­ã‚°ã‚¤ãƒ³</button>
    <input type="text" id="projectName" placeholder="ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’å…¥åŠ›" /><br><br>
    <button onclick="listFolders()">ğŸ“‚ è¦ªãƒ•ã‚©ãƒ«ãƒ€é¸æŠ</button>
    <div id="folderList">(ãƒ•ã‚©ãƒ«ãƒ€ä¸€è¦§ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™)</div><br>
    <button onclick="startProjectCreation()">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ</button>
    <pre id="log">(ã“ã“ã«ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™)</pre>
  </div>

  <!-- Dashboard Page -->
  <div id="page-dashboard" class="page">
    <h2>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå†…å®¹</h2>
    <select id="projectSelect" onchange="selectProject(this.value)">
      <option value="">-- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠ --</option>
    </select>
    <button onclick="createMemo()">ğŸ“ ãƒ¡ãƒ¢æ–°è¦ä½œæˆ</button>
    <div id="dropZone">ã“ã“ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ï¼ˆã¾ãŸã¯ä¸‹ã®ãƒœã‚¿ãƒ³ã§é¸æŠï¼‰</div>
    <input type="file" id="filePicker" multiple style="margin-top:10px;" />
    <ul id="filePreview"></ul>
    <button onclick="uploadAll()">å®Œäº†ã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
    <h3>ğŸ“„ ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§</h3>
    <div id="fileList">(èª­ã¿è¾¼ã¿ä¸­...)</div>
  </div>

  <!-- Edit Page -->
  <div id="page-edit" class="page">
    <h2 id="projectTitle">ğŸ“ Markdownç·¨é›†</h2>
    <button onclick="save()">ğŸ’¾ ä¿å­˜</button>
    <textarea id="editor"></textarea>
    <h3>ğŸ“„ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
    <div id="preview"></div>
  </div>

  <script>
    // ======== ãƒšãƒ¼ã‚¸åˆ‡ã‚Šæ›¿ãˆ ==========
    function showPage(name) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById(`page-${name}`).classList.add('active');
      if (name === 'dashboard') {
        listProjects();
        displayFiles();
      }
    }

    const token = localStorage.getItem("accessToken");
    let mapFileId = localStorage.getItem("mapFileId");
    let currentEditFileId = null;

    // ======== Index éƒ¨åˆ† ==========
    function storageClear() {
      localStorage.clear();
      alert("LocalStorageã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ");
    }

    function updateLoginStatus() {
      const status = document.getElementById("loginStatus");
      if (!status) return;
      const expiresAt = Number(localStorage.getItem("accessTokenExpiresAt") || "0");
      const now = Date.now();
      const isLoggedIn = expiresAt > now;
      status.textContent = isLoggedIn
        ? `âœ… ãƒ­ã‚°ã‚¤ãƒ³ä¸­ï¼ˆæ®‹ã‚Šç´„ ${Math.floor((expiresAt - now) / 60000)} åˆ†ï¼‰`
        : "âš ï¸ ãƒ­ã‚°ã‚¢ã‚¦ãƒˆçŠ¶æ…‹ï¼ˆå†ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ï¼‰";
      if (!isLoggedIn) {
        localStorage.removeItem("accessToken");
        localStorage.removeItem("accessTokenExpiresAt");
      }
    }
    updateLoginStatus();
    setInterval(updateLoginStatus, 60000);

    const clientId = "295167116096-sva04gs0vtr6hvof2r1cfdtlqre4ohpb.apps.googleusercontent.com";
    const redirectUri = "https://chigaac.github.io/callback.html";
    const scope = "https://www.googleapis.com/auth/drive.file";

    let selectedParentId = null;
    const log = msg => document.getElementById("log").textContent += `\n${msg}`;

    function redirectLogin() {
      const params = new URLSearchParams({
        client_id: clientId, redirect_uri: redirectUri, response_type: "token",
        scope: scope, include_granted_scopes: "true"
      });
      location.href = `https://accounts.google.com/o/oauth2/v2/auth?${params}`;
    }

    async function ensureNyuunFolder(token) {
      const query = encodeURIComponent("name = 'nyu--n' and mimeType = 'application/vnd.google-apps.folder' and trashed = false");
      const res = await fetch(`https://www.googleapis.com/drive/v3/files?q=${query}&fields=files(id,name)`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      const data = await res.json();
      if (data.files.length > 0) return data.files[0].id;
      const createRes = await fetch("https://www.googleapis.com/drive/v3/files", {
        method: "POST",
        headers: { Authorization: `Bearer ${token}`, "Content-Type": "application/json" },
        body: JSON.stringify({ name: "nyu--n", mimeType: "application/vnd.google-apps.folder" })
      });
      const created = await createRes.json();
      return created.id;
    }

    async function startProjectCreation() {
      const token = localStorage.getItem("accessToken");
      if (!token) return log("âŒ ãƒˆãƒ¼ã‚¯ãƒ³ãŒæœªå–å¾—ã§ã™");
      const projectName = document.getElementById("projectName").value.trim();
      if (!projectName) return log("âŒ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

      let parentId = selectedParentId || await ensureNyuunFolder(token);
      localStorage.setItem("pendingProjectName", projectName);
      localStorage.setItem("pendingParentId", parentId);
      createProject(projectName, parentId, token);
    }

    async function listFolders() {
      const token = localStorage.getItem("accessToken");
      const res = await fetch("https://www.googleapis.com/drive/v3/files?q=mimeType='application/vnd.google-apps.folder' and trashed=false&fields=files(id,name)", {
        headers: { Authorization: `Bearer ${token}` }
      });
      const result = await res.json();
      const div = document.getElementById("folderList");
      div.innerHTML = "";
      result.files.forEach(f => {
        const btn = document.createElement("button");
        btn.textContent = f.name;
        btn.onclick = () => { selectedParentId = f.id; log(`ğŸ“Œ è¦ªãƒ•ã‚©ãƒ«ãƒ€é¸æŠ: ${f.name}`); };
        div.appendChild(btn);
        div.appendChild(document.createElement("br"));
      });
    }

    async function createProject(name, parentId, token) {
      const projectId = await createFolder(name, parentId, token);
      const memoId = await createFolder("ãƒ¡ãƒ¢", projectId, token);
      const embedId = await createFolder("åŸ‹ã‚è¾¼ã¿ãƒ•ã‚¡ã‚¤ãƒ«", projectId, token);
      const dataId = await createFolder("ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿", projectId, token);

      const map = { projectName: name, folders: { memo: memoId, embed: embedId, data: dataId }, files: [] };
      const metadata = { name: "map.json", mimeType: "application/json", parents: [projectId] };
      const form = new FormData();
      form.append("metadata", new Blob([JSON.stringify(metadata)], { type: "application/json" }));
      form.append("file", new Blob([JSON.stringify(map, null, 2)], { type: "application/json" }));

      const upload = await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart", {
        method: "POST", headers: { Authorization: `Bearer ${token}` }, body: form
      });

      if (upload.ok) {
        const mapInfo = await upload.json();
        localStorage.setItem("mapFileId", mapInfo.id);
        mapFileId = mapInfo.id;
        alert("âœ… ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆå®Œäº†");
      } else log("âŒ map.json ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—");
    }

    async function createFolder(name, parentId, token) {
      const res = await fetch("https://www.googleapis.com/drive/v3/files", {
        method: "POST",
        headers: { Authorization: `Bearer ${token}`, "Content-Type": "application/json" },
        body: JSON.stringify({ name, mimeType: "application/vnd.google-apps.folder", parents: [parentId] })
      });
      return (await res.json()).id;
    }

    // ======== Dashboard éƒ¨åˆ† ==========
    async function fetchMapJson() {
      if (!mapFileId) return null;
      const res = await fetch(`https://www.googleapis.com/drive/v3/files/${mapFileId}?alt=media`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      return await res.json();
    }

    async function listProjects() {
      const res = await fetch(
        "https://www.googleapis.com/drive/v3/files?q=name='map.json' and trashed=false&fields=files(id,name,parents)",
        { headers: { Authorization: `Bearer ${token}` } }
      );
      const data = await res.json();
      const select = document.getElementById("projectSelect");
      select.innerHTML = "<option value=''>-- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠ --</option>";
      for (const f of data.files) {
        let parentName = "(ä¸æ˜)";
        if (f.parents && f.parents.length > 0) {
          const parentId = f.parents[0];
          const parentRes = await fetch(`https://www.googleapis.com/drive/v3/files/${parentId}?fields=name`, {
            headers: { Authorization: `Bearer ${token}` }
          });
          const parentData = await parentRes.json();
          parentName = parentData.name;
        }
        const option = document.createElement("option");
        option.value = f.id;
        option.textContent = parentName;
        if (f.id === mapFileId) option.selected = true;
        select.appendChild(option);
      }
    }

    function selectProject(id) {
      if (!id) return;
      mapFileId = id;
      localStorage.setItem("mapFileId", id);
      displayFiles();
    }

    async function listFiles(folderId) {
      const res = await fetch(`https://www.googleapis.com/drive/v3/files?q='${folderId}'+in+parents+and+trashed=false`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      const data = await res.json();
      return data.files || [];
    }

    async function displayFiles() {
      const listEl = document.getElementById("fileList");
      if (!mapFileId) { listEl.textContent = "âŒ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“"; return; }
      try {
        const map = await fetchMapJson();
        if (!map) return;
        const memoFiles = await listFiles(map.folders.memo);
        const embedFiles = await listFiles(map.folders.embed);
        listEl.innerHTML = "<strong>ğŸ—‚ ãƒ¡ãƒ¢:</strong><br/>";
        memoFiles.forEach(f => {
          const a = document.createElement("a");
          a.href = "#";
          a.textContent = f.name;
          a.onclick = () => { currentEditFileId = f.id; showPage('edit'); loadFile(); };
          listEl.appendChild(a);
        });
        listEl.innerHTML += "<br/><strong>ğŸ–‡ åŸ‹ã‚è¾¼ã¿ãƒ•ã‚¡ã‚¤ãƒ«:</strong><br/>";
        embedFiles.forEach(f => {
          const a = document.createElement("a");
          a.href = `https://drive.google.com/file/d/${f.id}/view`;
          a.textContent = f.name;
          a.target = "_blank";
          listEl.appendChild(a);
        });
      } catch (e) { listEl.textContent = "âŒ ã‚¨ãƒ©ãƒ¼"; console.error(e); }
    }

    async function createMemo() {
      if (!mapFileId) { alert("âŒ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"); return; }
      const map = await fetchMapJson();
      const fileName = `æ–°è¦ãƒ¡ãƒ¢_${Date.now()}.md`;
      const metadata = { name: fileName, mimeType: "text/markdown", parents: [map.folders.memo] };
      const form = new FormData();
      form.append("metadata", new Blob([JSON.stringify(metadata)], { type: "application/json" }));
      form.append("file", new Blob([""], { type: "text/markdown" }));
      const res = await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart", {
        method: "POST", headers: { Authorization: `Bearer ${token}` }, body: form
      });
      if (!res.ok) { alert("âŒ ãƒ¡ãƒ¢ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ"); return; }
      const newFile = await res.json();
      map.files.push({ id: newFile.id, name: fileName, path: ["memo"], as: "memo", created: new Date().toISOString() });
      await saveMap(map);
      currentEditFileId = newFile.id;
      showPage('edit');
      loadFile();
    }

    async function saveMap(map) {
      const form = new FormData();
      form.append("metadata", new Blob([JSON.stringify({ name: "map.json", mimeType: "application/json" })], { type: "application/json" }));
      form.append("file", new Blob([JSON.stringify(map, null, 2)], { type: "application/json" }));
      await fetch(`https://www.googleapis.com/upload/drive/v3/files/${mapFileId}?uploadType=multipart`, {
        method: "PATCH", headers: { Authorization: `Bearer ${token}` }, body: form
      });
    }

    // --- ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç† ---
    let pendingFiles = [];
    const dropZone = document.getElementById("dropZone");
    const filePicker = document.getElementById("filePicker");
    const filePreview = document.getElementById("filePreview");

    dropZone.addEventListener("dragover", e => {
      e.preventDefault();
      dropZone.style.background = "#eef";
    });
    dropZone.addEventListener("dragleave", () => dropZone.style.background = "");
    dropZone.addEventListener("drop", e => {
      e.preventDefault();
      dropZone.style.background = "";
      pendingFiles.push(...Array.from(e.dataTransfer.files));
      refreshPreview();
    });
    filePicker.addEventListener("change", e => {
      pendingFiles.push(...Array.from(e.target.files));
      refreshPreview();
      filePicker.value = "";
    });

    function refreshPreview() {
      filePreview.innerHTML = "";
      pendingFiles.forEach((file, index) => {
        const li = document.createElement("li");
        const nameSpan = document.createElement("span");
        nameSpan.textContent = `${file.name} (${Math.round(file.size / 1024)} KB) `;
        li.appendChild(nameSpan);

        const preview = document.createElement("span");
        preview.style.margin = "0 10px";
        preview.style.display = "inline-block";

        if (file.type.startsWith("image/")) {
          const img = document.createElement("img");
          img.style.maxWidth = "80px";
          img.style.maxHeight = "60px";
          img.style.objectFit = "cover";
          const reader = new FileReader();
          reader.onload = e => (img.src = e.target.result);
          reader.readAsDataURL(file);
          preview.appendChild(img);
        } else if (file.type.startsWith("video/")) {
          preview.textContent = "ğŸï¸";
        } else if (file.type.startsWith("audio/")) {
          preview.textContent = "ğŸµ";
        } else if (file.type.startsWith("text/") || file.type === "application/json") {
          const reader = new FileReader();
          reader.onload = e => {
            const content = e.target.result.slice(0, 20).replace(/\n/g, " ");
            preview.textContent = `ğŸ“ ${content}${content.length >= 20 ? "..." : ""}`;
          };
          reader.readAsText(file);
        } else {
          preview.textContent = "ğŸ“„";
        }
        li.appendChild(preview);

        const delBtn = document.createElement("button");
        delBtn.textContent = "å‰Šé™¤";
        delBtn.onclick = () => {
          pendingFiles.splice(index, 1);
          refreshPreview();
        };
        li.appendChild(delBtn);

        filePreview.appendChild(li);
      });
    }

    async function uploadAll() {
      if (!mapFileId) {
        alert("âŒ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
        return;
      }
      if (pendingFiles.length === 0) {
        alert("ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“");
        return;
      }

      const map = await fetchMapJson();
      const uploadRoot = map.folders.data;

      const now = new Date();
      const folderName = now.toISOString().replace(/[-:]/g, "").slice(0, 15).replace("T", "_");
      const folderId = await createFolder(folderName, uploadRoot, token);

      for (const file of pendingFiles) {
        await uploadFileToFolder(file, folderId, token);
      }

      alert("âœ… ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†ï¼");
      pendingFiles = [];
      refreshPreview();
      displayFiles();
    }

    async function uploadFileToFolder(file, parentId, token) {
      const metadata = { name: file.name, parents: [parentId] };
      const form = new FormData();
      form.append("metadata", new Blob([JSON.stringify(metadata)], { type: "application/json" }));
      form.append("file", file);
      await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart", {
        method: "POST",
        headers: { Authorization: `Bearer ${token}` },
        body: form
      });
    }

    // ======== Edit éƒ¨åˆ† ==========
    const editor = document.getElementById("editor");
    const preview = document.getElementById("preview");

    async function loadFile() {
      if (!currentEditFileId) return;
      const res = await fetch(`https://www.googleapis.com/drive/v3/files/${currentEditFileId}?alt=media`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      const text = await res.text();
      editor.value = text;
      updatePreview();
    }

    function updatePreview() {
      preview.innerHTML = marked.parse(editor.value);
    }
    editor.addEventListener("input", updatePreview);

    async function save() {
      if (!currentEditFileId) return;
      const content = editor.value;
      const res = await fetch(`https://www.googleapis.com/upload/drive/v3/files/${currentEditFileId}?uploadType=media`, {
        method: "PATCH", headers: { Authorization: `Bearer ${token}` }, body: content
      });
      if (res.ok) alert("âœ… ä¿å­˜ã—ã¾ã—ãŸï¼");
    }

    // åˆæœŸåŒ–
    listProjects();
    displayFiles();
  </script>
</body>
</html>
