<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' https://cdn.jsdelivr.net 'unsafe-inline';
        connect-src 'self' https://www.googleapis.com https://accounts.google.com;
        img-src 'self' data: blob:;
        media-src 'self' blob:;
        style-src 'self' 'unsafe-inline';
    ">


    <title>統合ツール</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 0;
        }

        #header {
            background: #f0f0f0;
            padding: 0.5em;
            display: flex;
            gap: 1em;
            position: sticky;
            top: 0;
        }

            #header button {
                padding: 0.4em 1em;
            }

        .page {
            display: none;
            padding: 1em;
        }

            .page.active {
                display: block;
            }

        #dropZone {
            border: 2px dashed #888;
            padding: 2em;
            text-align: center;
            margin-top: 1em;
        }

        #filePreview li {
            margin: 0.3em 0;
            list-style: none;
        }

        #filePreview img {
            vertical-align: middle;
        }

        button {
            margin-left: 0.5em;
        }

        textarea {
            width: 100%;
            height: 200px;
        }

        #preview {
            border: 1px solid #ccc;
            padding: 10px;
            margin-top: 10px;
        }

        #dashboardLayout {
            display: flex;
            gap: 1em;
            margin-top: 1em;
        }

        #projectTreePanel {
            width: 250px;
            border: 1px solid #ccc;
            padding: 10px;
            overflow-y: auto;
            max-height: 70vh;
        }

        #fileListPanel {
            flex: 1;
            border: 1px solid #ccc;
            padding: 10px;
            overflow-y: auto;
            max-height: 70vh;
        }

        #projectTreeContainer ul {
            list-style-type: none;
            padding-left: 1em;
            margin: 0;
        }

        #projectTreeContainer li {
            list-style: none;
            cursor: pointer;
            margin: 0.2em 0;
        }

            #projectTreeContainer li:hover {
                background: #eef;
            }

        #fileList ul {
            list-style-type: none;
            padding-left: 1em;
            margin: 0;
        }

        #fileList li {
            margin: 0.2em 0;
        }
    </style>
</head>
<body>
    <div id="header">
        <button onclick="showPage('index')">Index</button>
        <button onclick="showPage('dashboard')">Dashboard</button>
        <button onclick="showPage('edit')">Edit</button>
        <button onclick="storageClear()">クリア</button>
        <button id="loginButton" onclick="redirectLogin()">Googleでログイン</button>
        <button id="modeSwitchBtn" style="display:none;" onclick="toggleMode()"></button>
    </div>

    <!-- Index Page -->
    <div id="page-index" class="page active">
        <h2>📁 Google Drive プロジェクト作成</h2>

        <input type="text" id="projectName" placeholder="プロジェクト名を入力" /><br><br>
        <button onclick="listFolders()">📂 親フォルダ選択</button>
        <div id="folderList">(フォルダ一覧がここに表示されます)</div><br>
        <button onclick="startProjectCreation()">プロジェクト作成</button>
        <pre id="log">(ここにログが表示されます)</pre>
    </div>
    <!-- Dashboard Page -->
    <div id="page-dashboard" class="page">
        <h2>プロジェクト内容</h2>
        <select id="projectSelect" onchange="selectProject(this.value)">
            <option value="">-- プロジェクトを選択 --</option>
        </select>
        <button onclick="listProjects()">プロジェクト一覧を取得</button>

        <div id="dashboardLayout">
            <!-- 左カラム：プロジェクト構造木 -->
            <div id="projectTreePanel">
                <h3>📂 プロジェクト構造</h3>
                <div id="projectTreeContainer">(構造木を構築中...)</div>
            </div>

            <!-- 右カラム：ファイルリスト -->
            <div id="fileListPanel">
                <h3>📄 ファイル一覧</h3>
                <button onclick="createMemo()">📝 メモ新規作成</button>
                <div id="dropZone">ここにファイルをドラッグ＆ドロップ（または下のボタンで選択）</div>
                <input type="file" id="filePicker" multiple style="margin-top:10px;" />
                <ul id="filePreview"></ul>
                <button onclick="uploadAll()">完了してアップロード</button>
                <div id="fileList">(読み込み中...)</div>
            </div>
        </div>

        <div id="filePreviewModal" style="display:none; border:1px solid #888; padding:10px; margin-top:20px;">
            <button onclick="closePreview()" style="float:right;">×</button>
            <div id="previewContent">(プレビューがここに表示されます)</div>
        </div>
    </div>
    <div id="page-edit" class="page">
        <h2>✏️ 編集</h2>
        <!-- タブヘッダ -->
        <div id="editTabs" class="tab-header">
            <!-- 例: <button class="tab active" data-id="fileId">ファイル名 ×</button> -->
        </div>

        <!-- タブごとの編集ビュー -->
        <div id="editContents" class="tab-contents">
            <!-- 例: <div class="editorPane active" data-id="fileId">...</div> -->
        </div>
    </div>


    <script>
        // ======== 共通部分 ==========
        //ブラウザ、ローカル間の切り替え
        function isElectron() {
            return !!(window.electronAPI && window.electronAPI.isElectron);
        }

        function initModeButton() {
            const btn = document.getElementById('modeSwitchBtn');
            if (!isElectron()) return; // Electron以外では非表示
            btn.style.display = 'inline-block';
            if (window.location.pathname.endsWith('local.html')) {
                btn.textContent = 'ブラウザモードに切り替える';
            } else {
                btn.textContent = 'ローカルモードに切り替える';
            }
        }

        function toggleMode() {
            if (window.location.pathname.endsWith('local.html')) {
                // local.html -> app.html
                window.location.href = 'app.html';
            } else {
                // app.html -> local.html
                window.location.href = 'local.html';
            }
        }
        async function findParentMapJson(folderId, pathStack = []) {
            if (!isLogin()) return;
            const token = getToken();
            if (!folderId || !rootNyuunId) return null;
            //pathStack.unshift("/");
            // 1. 現在のフォルダで map.json を検索
            const query = encodeURIComponent(`'${folderId}' in parents and name = 'map.json' and trashed = false`);
            const res = await fetch(`https://www.googleapis.com/drive/v3/files?q=${query}&fields=files(id,name,parents)`, {
                headers: { Authorization: `Bearer ${token}` }
            });
            const data = await res.json();
            if (data.files.length > 0)
                return {
                    parentMapId: data.files[0].id,
                    path: pathStack
                };
            const folderRes = await fetch(
                `https://www.googleapis.com/drive/v3/files/${folderId}?fields=id,name,parents`,
                { headers: { Authorization: `Bearer ${token}` } }
            );
            const folderData = await folderRes.json();

            if (!folderData.parents || folderData.parents.length === 0) return null;

            const parentId = folderData.parents[0];
            if (parentId === rootNyuunId) return null; // nyu--nに到達したら終了
            pathStack.unshift(folderData.name);

            return await findParentMapJson(parentId, pathStack);
        }
        async function updateParentMapWithProject(parentMapId, projectInfo) {
            const res = await fetch(`https://www.googleapis.com/drive/v3/files/${parentMapId}?alt=media`, {
                headers: { Authorization: `Bearer ${getToken()}` }
            });
            const parentMap = await res.json();
            parentMap.files.push(projectInfo);
            await saveSpecificMap(parentMap, parentMapId);
        }

        async function saveSpecificMap(map, fileId) {
            const form = new FormData();
            form.append("metadata", new Blob([JSON.stringify({ name: "map.json", mimeType: "application/json" })], { type: "application/json" }));
            form.append("file", new Blob([JSON.stringify(map, null, 2)], { type: "application/json" }));
            await fetch(`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=multipart`, {
                method: "PATCH", headers: { Authorization: `Bearer ${getToken()}` }, body: form
            });
        }
        // ======== ページ切り替え ==========
        function showPage(name) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(`page-${name}`).classList.add('active');
            //if (!token) return; unya
            if (!isLogin()) return;
            if (name === 'dashboard') {
                listProjects();
                displayFiles();
            }
        }
        function updatePreview() {
            const editor = document.getElementById("editor");
            const preview = document.getElementById("preview");
            preview.innerHTML = marked.parse(editor.value);
        }

        let currentEditFileId = null;

        // ======== Index 部分 ==========
        function storageClear() {
            localStorage.clear();
            alert("LocalStorageをクリアしました");
        }
        function updateLoginStatus() {
            const status = document.getElementById("loginButton");
            if (!status) return;
            const expiresAt = Number(localStorage.getItem("accessTokenExpiresAt") || "0");
            const now = Date.now();
            const isLoggedIn = expiresAt > now;
            status.textContent = isLoggedIn
                ? `✅ ログイン中（残り約 ${Math.floor((expiresAt - now) / 60000)} 分）`
                : "⚠️ ログアウト状態（再ログインしてください）";
            if (!isLoggedIn) {
                localStorage.removeItem("accessToken");
                localStorage.removeItem("accessTokenExpiresAt");
            }
        }
        updateLoginStatus();
        setInterval(updateLoginStatus, 60000);

        function isLogin() {
            const expiresAt = Number(localStorage.getItem("accessTokenExpiresAt") || "0");
            return expiresAt > Date.now();
        }
        function getToken() {
            return localStorage.getItem("accessToken");
        }

        const clientId = "295167116096-sva04gs0vtr6hvof2r1cfdtlqre4ohpb.apps.googleusercontent.com";
        const redirectUri = "https://chigaac.github.io/callback.html";
        const scope = "https://www.googleapis.com/auth/drive.file";

        let selectedParentId = null;
        const log = msg => document.getElementById("log").textContent += `\n${msg}`;
        async function redirectLogin() {
            if (isElectron()) {
                const token = await window.electronAPI.login();
                log("Electron token:", token);
                if (token) {
                    localStorage.setItem("accessToken", token);
                    const expiresAt = Date.now() + 3600 * 1000;
                    localStorage.setItem("accessTokenExpiresAt", expiresAt);
                    updateLoginStatus();
                    await listProjects(); // 追加
                    await displayFiles(); // 追加
                }
                return;
            }

            // Web版フロー
            const params = new URLSearchParams({
                client_id: clientId, redirect_uri: redirectUri, response_type: "token",
                scope: scope, include_granted_scopes: "true"
            });
            location.href = `https://accounts.google.com/o/oauth2/v2/auth?${params}`;
        }

        async function ensureNyuunFolder(token) {
            if (!token) return;
            const query = encodeURIComponent("name = 'nyu--n' and mimeType = 'application/vnd.google-apps.folder' and trashed = false");
            const res = await fetch(`https://www.googleapis.com/drive/v3/files?q=${query}&fields=files(id,name)`, {
                headers: { Authorization: `Bearer ${token}` }
            });
            const data = await res.json();
            if (data.files.length > 0) return data.files[0].id;
            const createRes = await fetch("https://www.googleapis.com/drive/v3/files", {
                method: "POST",
                headers: { Authorization: `Bearer ${tokne}`, "Content-Type": "application/json" },
                body: JSON.stringify({ name: "nyu--n", mimeType: "application/vnd.google-apps.folder" })
            });
            const created = await createRes.json();
            return created.id;
        }
        async function startProjectCreation() {
            const token = getToken();
            if (!token) return log("❌ トークンが未取得です");

            const projectName = document.getElementById("projectName").value.trim();
            if (!projectName) return log("❌ プロジェクト名を入力してください");

            log(`📌 プロジェクト '${projectName}' を作成します...`);

            let parentId = selectedParentId || await ensureNyuunFolder(token);
            if (selectedParentId) {
                log(`📂 選択された親フォルダ: ${selectedParentId}`);
            } else {
                log("📂 'nyu--n' フォルダを使用します");
            }

            localStorage.setItem("pendingProjectName", projectName);
            localStorage.setItem("pendingParentId", parentId);

            const newMapId = await createProject(projectName, parentId, token);
            if (!newMapId) return;

            // 親の map.json に新プロジェクトを登録
            if (selectedParentId) {
                //const parentMapId = await findParentMapJson(selectedParentId);
                const { parentMapId, path } = await findParentMapJson(selectedParentId);
                if (parentMapId) {
                    await updateParentMapWithProject(parentMapId, {
                        id: newMapId, // ★新しく作成した子プロジェクトの map.json ID を登録
                        name: projectName,
                        path: path,
                        as: "project",
                        created: new Date().toISOString()
                    });
                    log("📌 親の map.json を更新しました");
                } else {
                    log("ℹ️ 上位 map.json は見つかりませんでした");
                }
            }
        }
        let rootNyuunId = null;

        async function findNyuunRootId(token) {
            const query = encodeURIComponent("name = 'nyu--n' and mimeType = 'application/vnd.google-apps.folder' and trashed = false");
            const res = await fetch(`https://www.googleapis.com/drive/v3/files?q=${query}&fields=files(id,name)`, {
                headers: { Authorization: `Bearer ${token }` }
            });
            const data = await res.json();
            if (data.files.length > 0) {
                rootNyuunId = data.files[0].id;
            }
        }
        async function listFolders() {
            const token = getToken();
            if (!token) {
                log("❌ トークンが未取得です");
                return;
            }
            await findNyuunRootId(token);
            const res = await fetch("https://www.googleapis.com/drive/v3/files?q=mimeType='application/vnd.google-apps.folder' and trashed=false&fields=files(id,name)", {
                headers: { Authorization: `Bearer ${token }` }
            });
            const result = await res.json();
            const div = document.getElementById("folderList");
            div.innerHTML = "";
            result.files.forEach(f => {
                const btn = document.createElement("button");
                btn.textContent = f.name;
                btn.onclick = () => { selectedParentId = f.id; log(`📌 親フォルダ選択: ${f.name}`); };
                div.appendChild(btn);
                div.appendChild(document.createElement("br"));
            });
        }
        async function createProject(name, parentId, token) {
            log(`📁 '${name}' プロジェクトを作成中...`);

            const projectId = await createFolder(name, parentId, token);
            log(`  └ プロジェクトフォルダ作成: ${projectId}`);

            const memoId = await createFolder("メモ", projectId, token);
            const embedId = await createFolder("埋め込みファイル", projectId, token);
            const dataId = await createFolder("アップロードデータ", projectId, token);

            const map = { projectName: name, folders: { memo: memoId, embed: embedId, data: dataId }, files: [] };
            const metadata = { name: "map.json", mimeType: "application/json", parents: [projectId] };

            const form = new FormData();
            form.append("metadata", new Blob([JSON.stringify(metadata)], { type: "application/json" }));
            form.append("file", new Blob([JSON.stringify(map, null, 2)], { type: "application/json" }));

            log("  └ map.json をアップロード中...");
            const upload = await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart", {
                method: "POST", headers: { Authorization: `Bearer ${token}` }, body: form
            });

            if (upload.ok) {
                const mapInfo = await upload.json();
                log("✅ プロジェクト作成完了");
                return mapInfo.id; // ★新規 map.json の ID を返す
            } else {
                log("❌ map.json アップロード失敗");
                return null;
            }
        }

        async function createFolder(name, parentId, token) {
            const res = await fetch("https://www.googleapis.com/drive/v3/files", {
                method: "POST",
                headers: { Authorization: `Bearer ${token}`, "Content-Type": "application/json" },
                body: JSON.stringify({ name, mimeType: "application/vnd.google-apps.folder", parents: [parentId] })
            });
            return (await res.json()).id;
        }

        // ======== Dashboard 部分 ==========
        let selectedProjectId = null;     // 「基準プロジェクト」 (ルートツリー)
        let currentViewProjectId = null;  // 「表示中のプロジェクト」 (右ペインのダッシュボード)
        let projectTreeCache = {};        // mapId -> 取得済み map.json のキャッシュ

        async function fetchMapJsonById(mapId, token) {
            if (!mapId || !token) return null;
            const res = await fetch(`https://www.googleapis.com/drive/v3/files/${mapId}?alt=media`, {
                headers: { Authorization: `Bearer ${token}` }
            });
            return await res.json();
        }
        async function listProjects() {
            if (!isLogin()) {
                console.warn("tokenが未取得のため listProjects() をスキップ");
                return;
            }
            const token = getToken();

            const res = await fetch(
                "https://www.googleapis.com/drive/v3/files?q=name='map.json' and trashed=false&fields=files(id,name,parents)",
                { headers: { Authorization: `Bearer ${token}` } }
            );
            const data = await res.json();
            const files = data.files || [];
            const select = document.getElementById("projectSelect");
            select.innerHTML = "<option value=''>-- プロジェクトを選択 --</option>";
            for (const f of files) {
                let parentName = "(不明)";
                if (f.parents && f.parents.length > 0) {
                    const parentId = f.parents[0];
                    const parentRes = await fetch(`https://www.googleapis.com/drive/v3/files/${parentId}?fields=name`, {
                        headers: { Authorization: `Bearer ${token}` }
                    });
                    const parentData = await parentRes.json();
                    parentName = parentData.name;
                }
                const option = document.createElement("option");
                option.value = f.id;
                option.textContent = parentName;
                if (f.id === selectedProjectId) option.selected = true;
                select.appendChild(option);
            }
        }
        async function selectProject(id) {
            if (!id) return;

            // 選択されたプロジェクトを selectedProjectId に反映
            selectedProjectId = id;
            currentViewProjectId = id; // 表示プロジェクトも選択されたものに更新
            await updateLeftPanel();
            await updateRightPanel();
        }
        async function updateLeftPanel() {
            if (!selectedProjectId) {
                document.getElementById("projectTreeContainer").textContent = "❌ プロジェクトが選択されていません";
                return;
            }
            await renderProjectTree(); // selectedProjectIdに基づいて左ツリー更新
        }
        async function updateRightPanel() {
            if (!currentViewProjectId) {
                document.getElementById("fileList").textContent = "❌ 表示プロジェクトが選択されていません";
                return;
            }
            await displayFiles(currentViewProjectId); // currentViewProjectIdに基づいて右リスト更新
        }
        const projectTrees = {};

        async function getProjectData(projectId,token) {
            if (!projectTrees[projectId]) {
                const map = await fetchMapJsonById(projectId,token);
                projectTrees[projectId] = {
                    map,
                    projectTree: null,
                    fileTree: null
                };
            }
            return projectTrees[projectId];
        }
        async function buildProjectTree(projectId,token) {
            // ここで getProjectData() を呼び出す
            const projectData = await getProjectData(projectId,token);
            const prevTree = projectData.projectTree?.find(c => c.id === file.id);

            const map = projectData.map;

            const root = {
                id: projectId,
                name: map.projectName || "未命名プロジェクト",
                type: "project",
                isOpen: prevTree?.isOpen ?? true,
                children: []
            };

            for (const file of map.files || []) {
                if (file.as === "project") {
                    const prevChild = prevTree?.children?.find(c => c.id === file.id);
                    const childTree = await buildProjectTree(file.id,token);
                    root.children.push(childTree);
                }
            }

            return root;
        }

        function renderProjectTreeNode(node) {
            const li = document.createElement("li");

            const toggle = document.createElement("span");
            toggle.textContent = node.isOpen ? "∨" : "＞";
            toggle.style.cursor = "pointer";
            toggle.style.marginRight = "5px";
            toggle.onclick = () => {
                node.isOpen = !node.isOpen;
                toggle.textContent = node.isOpen ? "∨" : "＞";
                childContainer.style.display = node.isOpen ? "block" : "none";
            };

            const label = document.createElement("span");
            label.textContent = `📁 ${node.name}`;
            label.style.cursor = "pointer";
            label.onclick = () => {
                currentViewProjectId = node.id;
                updateRightPanel();
            };

            const childContainer = document.createElement("ul");
            childContainer.style.display = node.isOpen ? "block" : "none";
            node.children.forEach(child => childContainer.appendChild(renderProjectTreeNode(child)));

            li.appendChild(toggle);
            li.appendChild(label);
            li.appendChild(childContainer);

            return li;
        }

        async function renderProjectTree() {
            if (!selectedProjectId) {
                document.getElementById("projectTreeContainer").textContent = "❌ プロジェクトが選択されていません";
                return;
            }
            const token = getToken();

            const tree = await buildProjectTree(selectedProjectId,token);

            const container = document.getElementById("projectTreeContainer");
            container.innerHTML = "";
            container.appendChild(renderProjectTreeNode(tree));
        }

        function renderFileTreeNode(node, parentPath = "",token) {
            const li = document.createElement("li");
            const label = document.createElement("span");

            // 編集ボタン（✏️）
            const editBtn = document.createElement("button");
            editBtn.textContent = "✏️";
            editBtn.style.marginLeft = "8px";
            editBtn.onclick = (e) => {
                e.stopPropagation(); // ファイル/フォルダ開閉イベントを阻止
                openEditTab(node);    // 新規タブ作成 & Editページへ
            };

            if (node.type === "folder" || node.type === "project") {
                label.textContent =
                    node.type === "project"
                        ? `👾 ${node.name} (Project)`
                        : `📁 ${node.name} (${node.children.length})`;

                const toggle = document.createElement("span");
                toggle.style.cursor = "pointer";
                toggle.style.marginRight = "5px";
                toggle.textContent = node.isOpen ? "∨" : "＞";
                const childContainer = document.createElement("ul");
                childContainer.style.display = node.isOpen ? "block" : "none";

                toggle.onclick = async () => {
                    node.isOpen = !node.isOpen;
                    toggle.textContent = node.isOpen ? "∨" : "＞";
                    childContainer.style.display = node.isOpen ? "block" : "none";

                    // サブプロジェクトを初回展開
                    if (node.type === "project" && node.isOpen) {
                        if (!fileTrees[node.id]) {
                            const subMap = await fetchMapJsonById(node.id, token);
                            fileTrees[node.id] = buildFileTree(subMap);
                        }
                        node.children = fileTrees[node.id].children;

                        childContainer.innerHTML = "";
                        node.children.forEach(child =>
                            childContainer.appendChild(renderFileTreeNode(child, `${parentPath}/${node.name}`,token))
                        );
                    }
                };

                li.appendChild(toggle);
                li.appendChild(label);
                li.appendChild(editBtn); // ✏️ボタンを追加
                li.appendChild(childContainer);

                node.children.forEach(child =>
                    childContainer.appendChild(renderFileTreeNode(child, `${parentPath}/${node.name}`,token))
                );
            } else {
                label.textContent = `📄 ${node.name}`;
                li.style.cursor = "pointer";

                li.onclick = () => {
                    showPreview(node);
                };

                li.appendChild(label);
                li.appendChild(editBtn); // ✏️ボタンを追加
            }

            return li;
        }

        function renderFileTree(tree,token) {
            const container = document.getElementById("fileList");
            container.innerHTML = "";

            const ul = document.createElement("ul");
            tree.children.forEach(child => ul.appendChild(renderFileTreeNode(child,"",token)));
            container.appendChild(ul);
        }
        // --- 右パネル用ツリーキャッシュ ---
        const fileTrees = {};  // projectId -> fileTree

        function buildFileTree(map, prevTree = null) {
            const root = prevTree || { name: "(root)", type: "folder", isOpen: true, children: [] };
            root.children = [];  // フルリセットして差し替え

            const topFolders = ["メモ", "埋め込みファイル", "アップロードデータ"];
            for (const folderName of topFolders) {
                const prevNode = prevTree?.children?.find(c => c.name === folderName && c.type === "folder");
                root.children.push({
                    name: folderName,
                    type: "folder",
                    isOpen: prevNode?.isOpen ?? true,
                    children: []
                });
            }

            addFilesToTree(root, map.files || [], prevTree);
            return root;
        }

        function addFilesToTree(parent, files, prevParent = null) {
            for (const file of files) {
                const pathParts = Array.isArray(file.path) ? file.path : (file.path ? [file.path] : []);
                let currentNode = parent;
                let prevNode = prevParent;

                for (const part of pathParts) {
                    let folderNode = currentNode.children.find(c => c.name === part && c.type === "folder");
                    let prevFolder = prevNode?.children?.find(c => c.name === part && c.type === "folder");

                    if (!folderNode) {
                        folderNode = {
                            name: part,
                            type: "folder",
                            isOpen: prevFolder?.isOpen ?? false,
                            children: []
                        };
                        currentNode.children.push(folderNode);
                    }

                    currentNode = folderNode;
                    prevNode = prevFolder;
                }

                const existing = currentNode.children.find(c => c.name === file.name && c.type !== "folder");
                if (!existing) {
                    const prevFileNode = prevNode?.children?.find(c => c.name === file.name);
                    currentNode.children.push({
                        ...file,
                        name: file.name,
                        type: file.as === "project" ? "project" : (file.as || "file"),
                        isOpen: prevFileNode?.isOpen ?? false,
                        children: []
                    });
                }
            }
        }
        async function addFiles(mapId = currentViewProjectId, newFiles) {
            const token = getToken();
            if (fileTrees[mapId]) {
                addFilesToTree(fileTrees[mapId], newFiles);
                renderFileTree(fileTrees[mapId],token);
            } else {
                // キャッシュがまだない場合は初期化
                fileTrees[mapId] = buildFileTree(map);
                renderFileTree(fileTrees[mapId],token);
            }
        }
        async function displayFiles(mapId = currentViewProjectId) {
            if (!mapId) return;
            const token = getToken();
            if (!fileTrees[mapId]) {
                const map = await fetchMapJsonById(mapId, token);
                fileTrees[mapId] = buildFileTree(map);
            }
            renderFileTree(fileTrees[mapId],token);
        }

        async function initDashboard() {
            if (!selectedProjectId) {
                console.warn("selectedProjectId が未設定です");
                return;
            }
            const token = getToken();
            renderProjectTree(token);
        }

        const previewCache = {};       // { fileId: { html, blobUrl, size } }
        const previewCacheOrder = [];
        const MAX_CACHE_ITEMS = 20;
        let previewCacheTotalSize = 0;  // キャッシュ合計サイズ（bytes）

        async function showPreview(file) {
            const modal = document.getElementById("filePreviewModal");
            const content = document.getElementById("previewContent");
            //content.innerHTML = "読み込み中...";

            const alwaysFetch = (file.name === "map.json");
            const token = getToken();

            // ファイルメタデータ取得
            const fileMetaRes = await fetch(
                `https://www.googleapis.com/drive/v3/files/${file.id}?fields=mimeType,size`,
                { headers: { Authorization: `Bearer ${token}` } }
            );
            const fileMeta = await fileMetaRes.json();
            const mimeType = fileMeta.mimeType || "application/octet-stream";

            // --- キャッシュがあれば再利用 ---
            if (!alwaysFetch && previewCache[file.id]) {
                console.log(`キャッシュサイズ: ${previewCache[file.id].size} bytes`);
                debugPreviewCache();

                // --- キャッシュ順序を更新（先頭に移動） ---
                const index = previewCacheOrder.indexOf(file.id);
                if (index !== -1) {
                    previewCacheOrder.splice(index, 1);  // 既存位置を削除
                    previewCacheOrder.unshift(file.id);  // 先頭に追加
                }

                content.innerHTML = previewCache[file.id].html;
                modal.style.display = "block";
                return;
            }

            let html = "";

            // --- テキストファイル ---
            if (mimeType.startsWith("text/") || mimeType === "application/json" || mimeType.includes("markdown")) {
                const textRes = await fetch(`https://www.googleapis.com/drive/v3/files/${file.id}?alt=media`, {
                    headers: { Authorization: `Bearer ${token}` }
                });
                const textContent = await textRes.text();
                const previewText =
                    textContent.length > 2000
                        ? textContent.slice(0, 2000) + "\n\n...（続きは省略）"
                        : textContent;
                html = `<pre style="white-space:pre-wrap; max-height:300px; overflow:auto;">${escapeHtml(previewText)}</pre>`;

                if (!alwaysFetch) addPreviewCache(file.id, html, null, textContent.length);

                content.innerHTML = html;
                modal.style.display = "block";
                return;
            }

            // --- 画像・音声・動画 ---
            const blobRes = await fetch(`https://www.googleapis.com/drive/v3/files/${file.id}?alt=media`, {
                headers: { Authorization: `Bearer ${token}` }
            });
            const blob = await blobRes.blob();
            const blobUrl = URL.createObjectURL(blob);

            if (mimeType.startsWith("image/")) {
                html = `<img src="${blobUrl}" style="max-width:100%; max-height:300px;">`;
            } else if (mimeType.startsWith("audio/")) {
                html = `<audio controls src="${blobUrl}" style="width:100%;"></audio>`;
            } else if (mimeType.startsWith("video/")) {
                html = `<video controls src="${blobUrl}" style="width:100%; max-height:300px;"></video>`;
            } else {
                html = `<p>このファイルタイプはプレビューに対応していません。</p>`;
            }

            if (!alwaysFetch) addPreviewCache(file.id, html, blobUrl, blob.size);

            console.log(`取得サイズ: ${blob.size} bytes`);
            debugPreviewCache();
            content.innerHTML = html;
            modal.style.display = "block";
        }
        function addPreviewCache(fileId, html, blobUrl, size) {
            // 既存キャッシュがある場合は、サイズを減算して古いBlob URLを解放
            if (previewCache[fileId]) {
                previewCacheTotalSize -= (previewCache[fileId].size || 0);
                if (previewCache[fileId].blobUrl) URL.revokeObjectURL(previewCache[fileId].blobUrl);
                previewCacheOrder.splice(previewCacheOrder.indexOf(fileId), 1);
            }

            // 新規キャッシュ登録
            previewCache[fileId] = { html, blobUrl, size };
            previewCacheOrder.unshift(fileId); // 先頭に追加（LRU対応）

            // サイズ加算
            previewCacheTotalSize += (size || 0);

            // 最大件数を超えた場合、古いキャッシュを削除
            while (previewCacheOrder.length > MAX_CACHE_ITEMS) {
                const oldId = previewCacheOrder.pop();
                if (previewCache[oldId]) {
                    previewCacheTotalSize -= (previewCache[oldId].size || 0);
                    if (previewCache[oldId].blobUrl) URL.revokeObjectURL(previewCache[oldId].blobUrl);
                    delete previewCache[oldId];
                }
            }

            console.log(`現在のキャッシュ合計サイズ: ${previewCacheTotalSize} bytes`);
        }

        function debugPreviewCache() {
            const table = Object.entries(previewCache).map(([id, entry]) => ({
                fileId: id,
                size: entry.size ? `${entry.size} bytes` : "-",
                hasBlobUrl: !!entry.blobUrl
            }));
            console.table(table);
            console.log("キャッシュ順序:", previewCacheOrder);
            console.log(`キャッシュ合計サイズ: ${previewCacheTotalSize} bytes`);
        }

        // HTMLエスケープ（テキストプレビューでHTMLタグを無効化するため）
        function escapeHtml(text) {
            return text.replace(/[&<>"']/g, function (m) {
                return {
                    "&": "&amp;",
                    "<": "&lt;",
                    ">": "&gt;",
                    '"': "&quot;",
                    "'": "&#39;"
                }[m];
            });
        }

        function closePreview() {
            document.getElementById("filePreviewModal").style.display = "none";
        }
        async function createMemo() {
            if (!currentViewProjectId) {
                alert("❌ プロジェクトを選択してください。");
                return;
            }

            // map.json を取得
            const map = await fetchMapJsonById(currentViewProjectId);
            const fileName = `新規メモ_${Date.now()}.md`;
            const metadata = { name: fileName, mimeType: "text/markdown", parents: [map.folders.memo] };

            // 空のメモファイルをアップロード
            const form = new FormData();
            form.append("metadata", new Blob([JSON.stringify(metadata)], { type: "application/json" }));
            form.append("file", new Blob([""], { type: "text/markdown" }));

            const res = await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart", {
                method: "POST",
                headers: { Authorization: `Bearer ${getToken()}` },
                body: form
            });
            if (!res.ok) {
                alert("❌ メモ作成に失敗しました");
                return;
            }

            // 新規ファイルの情報を取得
            const newFile = await res.json();
            const fileEntry = {
                id: newFile.id,
                name: fileName,
                path: ["メモ"],
                as: "memo",
                created: new Date().toISOString()
            };

            // map.json に追加
            map.files.push(fileEntry);
            await saveMap(map);

            // ファイルツリーに反映
            addFiles(currentViewProjectId, [fileEntry]);

            // タブを開く
            openEditTab(fileEntry);
        }

        async function saveMap(map, id = currentViewProjectId) {
            if (!id) { alert("❌ プロジェクトを選択してください。"); return; }
            const form = new FormData();
            form.append(
                "metadata",
                new Blob(
                    [JSON.stringify({ name: "map.json", mimeType: "application/json" })],
                    { type: "application/json" }
                )
            );
            form.append(
                "file",
                new Blob([JSON.stringify(map, null, 2)], { type: "application/json" })
            );

            await fetch(`https://www.googleapis.com/upload/drive/v3/files/${id}?uploadType=multipart`, {
                method: "PATCH",
                headers: { Authorization: `Bearer ${getToken()}` },
                body: form
            });
        }


        // --- アップロード処理 ---
        let pendingFiles = [];
        const dropZone = document.getElementById("dropZone");
        const filePicker = document.getElementById("filePicker");
        const filePreview = document.getElementById("filePreview");

        dropZone.addEventListener("dragover", e => {
            e.preventDefault();
            dropZone.style.background = "#eef";
        });
        dropZone.addEventListener("dragleave", () => dropZone.style.background = "");
        dropZone.addEventListener("drop", e => {
            e.preventDefault();
            dropZone.style.background = "";
            pendingFiles.push(...Array.from(e.dataTransfer.files));
            refreshPreview();
        });
        filePicker.addEventListener("change", e => {
            pendingFiles.push(...Array.from(e.target.files));
            refreshPreview();
            filePicker.value = "";
        });

        function refreshPreview() {
            filePreview.innerHTML = "";
            pendingFiles.forEach((file, index) => {
                const li = document.createElement("li");
                const nameSpan = document.createElement("span");
                nameSpan.textContent = `${file.name} (${Math.round(file.size / 1024)} KB) `;
                li.appendChild(nameSpan);

                const preview = document.createElement("span");
                preview.style.margin = "0 10px";
                preview.style.display = "inline-block";

                if (file.type.startsWith("image/")) {
                    const img = document.createElement("img");
                    img.style.maxWidth = "80px";
                    img.style.maxHeight = "60px";
                    img.style.objectFit = "cover";
                    const reader = new FileReader();
                    reader.onload = e => (img.src = e.target.result);
                    reader.readAsDataURL(file);
                    preview.appendChild(img);
                } else if (file.type.startsWith("video/")) {
                    preview.textContent = "🎞️";
                } else if (file.type.startsWith("audio/")) {
                    preview.textContent = "🎵";
                } else if (file.type.startsWith("text/") || file.type === "application/json") {
                    const reader = new FileReader();
                    reader.onload = e => {
                        const content = e.target.result.slice(0, 20).replace(/\n/g, " ");
                        preview.textContent = `📝 ${content}${content.length >= 20 ? "..." : ""}`;
                    };
                    reader.readAsText(file);
                } else {
                    preview.textContent = "📄";
                }
                li.appendChild(preview);

                const delBtn = document.createElement("button");
                delBtn.textContent = "削除";
                delBtn.onclick = () => {
                    pendingFiles.splice(index, 1);
                    refreshPreview();
                };
                li.appendChild(delBtn);

                filePreview.appendChild(li);
            });
        }
        async function uploadAll() {
            if (!currentViewProjectId) {
                alert("❌ プロジェクトを選択してください。");
                return;
            }
            if (pendingFiles.length === 0) {
                alert("アップロードするファイルがありません");
                return;
            }
            const token = getToken();

            // map.json を取得
            const map = await fetchMapJsonById(currentViewProjectId, token);
            const uploadRoot = map.folders.data;

            // 新しいアップロードフォルダを作成
            const now = new Date();
            const folderName = now.toISOString().replace(/[-:]/g, "").slice(0, 15).replace("T", "_");
            const folderId = await createFolder(folderName, uploadRoot, token);

            // ファイルを順次アップロード
            const newFiles = [];
            for (const file of pendingFiles) {
                const newFile = await uploadFileToFolder(file, folderId, token);

                // map.json に追記
                const fileEntry = {
                    id: newFile.id,
                    name: file.name,
                    path: ["アップロードデータ", folderName],
                    as: "embed",  // 固定で embed
                    created: new Date().toISOString()
                };
                map.files.push(fileEntry);
                newFiles.push(fileEntry);
            }

            // map.json を保存
            await saveMap(map);

            addFiles(currentViewProjectId, newFiles);

            // UI更新
            alert("✅ アップロード完了！");
            pendingFiles = [];
            refreshPreview();
        }

        async function uploadFileToFolder(file, parentId, token) {
            const metadata = { name: file.name, parents: [parentId] };
            const form = new FormData();
            form.append("metadata", new Blob([JSON.stringify(metadata)], { type: "application/json" }));
            form.append("file", file);
            const res = await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart", {
                method: "POST",
                headers: { Authorization: `Bearer ${token}` },
                body: form
            });
            return await res.json(); // id取得のためレスポンスを返す
        }
        // ======== Edit 部分 ==========
        const editor = document.getElementById("editor");
        const preview = document.getElementById("preview");

        function openEditTab(file) {
            // 既にタブがあるか確認
            const existingTab = document.querySelector(`#editTabs .tab[data-id="${file.id}"]`);
            if (existingTab) {
                setActiveTab(file.id);
                showPage('edit');
                return;
            }

            // タブ作成
            const tabBtn = document.createElement("button");
            tabBtn.className = "tab";
            tabBtn.dataset.id = file.id;
            tabBtn.textContent = file.name;

            // ×ボタン
            const closeBtn = document.createElement("span");
            closeBtn.textContent = " ×";
            closeBtn.onclick = e => { e.stopPropagation(); closeTab(file.id); };
            tabBtn.appendChild(closeBtn);

            tabBtn.onclick = () => setActiveTab(file.id);
            document.getElementById("editTabs").appendChild(tabBtn);

            // エディタビュー作成
            const content = document.createElement("div");
            content.className = "editorPane";
            content.dataset.id = file.id;
            document.getElementById("editContents").appendChild(content);

            // ファイルタイプ別UI
            createEditView(content, file);

            setActiveTab(file.id);
            showPage('edit');
        }
        async function loadFileContent(fileId, textarea, preview) {
            try {
                // ファイル内容を取得
                const res = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {
                    headers: { Authorization: `Bearer ${token}` }
                });
                if (!res.ok) {
                    textarea.value = "";
                    preview.innerHTML = "<p>❌ ファイルの読み込みに失敗しました</p>";
                    return;
                }
                const text = await res.text();
                textarea.value = text;

                // プレビュー更新（Markdown対応）
                const updatePreview = () => {
                    preview.innerHTML = marked.parse(textarea.value);
                };
                textarea.addEventListener("input", updatePreview);
                updatePreview();  // 初期表示
            } catch (e) {
                console.error("loadFileContent error:", e);
                textarea.value = "";
                preview.innerHTML = "<p>❌ 読み込み中にエラーが発生しました</p>";
            }
        }

        function createEditView(container, file) {
            // ファイル名変更UI
            const nameInput = document.createElement("input");
            nameInput.value = file.name;
            const renameBtn = document.createElement("button");
            renameBtn.textContent = "名前を保存";
            renameBtn.onclick = () => renameFile(file.id, nameInput.value);
            container.appendChild(nameInput);
            container.appendChild(renameBtn);
            const saveBtn = document.createElement("button");
            saveBtn.textContent = "内容を保存";
            saveBtn.onclick = () => saveFile(file.id, textarea.value);
            container.appendChild(saveBtn);

            // 内容編集UI
            if (file.as === "memo" || file.mimeType?.includes("markdown") || file.mimeType?.startsWith("text/")) {
                const textarea = document.createElement("textarea");
                container.appendChild(textarea);

                const preview = document.createElement("div");
                container.appendChild(preview);

                // ファイルロード
                loadFileContent(file.id, textarea, preview);

                // 保存ボタン
                const saveBtn = document.createElement("button");
                saveBtn.textContent = "内容を保存";
                saveBtn.onclick = () => saveFile(file.id, textarea.value);
                container.appendChild(saveBtn);
            } else if (file.mimeType?.startsWith("image/") || file.mimeType?.startsWith("video/")) {
                const preview = document.createElement(file.mimeType.startsWith("image/") ? "img" : "video");
                preview.controls = file.mimeType.startsWith("video/");
                preview.style.maxWidth = "100%";
                container.appendChild(preview);
                loadPreviewFile(file.id, preview);
            } else if (file.type === "folder") {
                const note = document.createElement("p");
                note.textContent = "フォルダは名前変更のみ可能です。";
                container.appendChild(note);
            }
        }
        function setActiveTab(tabId) {
            document.querySelectorAll("#editTabs .tab").forEach(tab =>
                tab.classList.toggle("active", tab.dataset.id === tabId)
            );
            document.querySelectorAll("#editContents .editorPane").forEach(pane =>
                pane.classList.toggle("active", pane.dataset.id === tabId)
            );
        }
        function closeTab(tabId) {
            const tabBtn = document.querySelector(`#editTabs .tab[data-id="${tabId}"]`);
            const content = document.querySelector(`#editContents .editorPane[data-id="${tabId}"]`);
            if (tabBtn) tabBtn.remove();
            if (content) content.remove();
            // 他のタブがあれば最初をアクティブ化
            const firstTab = document.querySelector("#editTabs .tab");
            if (firstTab) setActiveTab(firstTab.dataset.id);
        }
        async function renameFile(fileId, newName) {
            // Google Drive 側
            await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}`, {
                method: "PATCH",
                headers: { Authorization: `Bearer ${getToken()}`, "Content-Type": "application/json" },
                body: JSON.stringify({ name: newName })
            });

            // map.json 側
            const map = await fetchMapJsonById(currentViewProjectId);
            const target = map.files.find(f => f.id === fileId);
            if (target) target.name = newName;
            await saveMap(map);

            alert("✅ 名前を変更しました");
        }
        async function saveFile(fileId, content) {
            try {
                const res = await fetch(`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`, {
                    method: "PATCH",
                    headers: { Authorization: `Bearer ${getToken()}` },
                    body: content
                });

                if (!res.ok) {
                    alert("❌ ファイルの保存に失敗しました");
                    console.error(await res.text());
                    return;
                }
                alert("✅ ファイルを保存しました！");
            } catch (e) {
                console.error("saveFile error:", e);
                alert("❌ 保存中にエラーが発生しました");
            }
        }

        initDashboard();
        initModeButton();
        // 初期化
        listProjects();
        displayFiles();
    </script>
</body>
</html>
