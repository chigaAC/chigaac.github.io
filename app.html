<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' https://cdn.jsdelivr.net 'unsafe-inline';
        connect-src 'self' https://www.googleapis.com https://accounts.google.com;
        img-src 'self' data: blob:;
        media-src 'self' blob:;
        style-src 'self' 'unsafe-inline';
    ">


    <title>çµ±åˆãƒ„ãƒ¼ãƒ«</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 0;
        }

        #header {
            background: #f0f0f0;
            padding: 0.5em;
            display: flex;
            gap: 1em;
            position: sticky;
            top: 0;
        }

            #header button {
                padding: 0.4em 1em;
            }

        .page {
            display: none;
            padding: 1em;
        }

            .page.active {
                display: block;
            }

        #dropZone {
            border: 2px dashed #888;
            padding: 2em;
            text-align: center;
            margin-top: 1em;
        }

        #filePreview li {
            margin: 0.3em 0;
            list-style: none;
        }

        #filePreview img {
            vertical-align: middle;
        }

        button {
            margin-left: 0.5em;
        }

        textarea {
            width: 100%;
            height: 200px;
        }

        #preview {
            border: 1px solid #ccc;
            padding: 10px;
            margin-top: 10px;
        }

        #dashboardLayout {
            display: flex;
            gap: 1em;
            margin-top: 1em;
        }

        #projectTreePanel {
            width: 250px;
            border: 1px solid #ccc;
            padding: 10px;
            overflow-y: auto;
            max-height: 70vh;
        }

        #fileListPanel {
            flex: 1;
            border: 1px solid #ccc;
            padding: 10px;
            overflow-y: auto;
            max-height: 70vh;
        }

        #projectTreeContainer ul {
            list-style-type: none;
            padding-left: 1em;
            margin: 0;
        }

        #projectTreeContainer li {
            list-style: none;
            cursor: pointer;
            margin: 0.2em 0;
        }

            #projectTreeContainer li:hover {
                background: #eef;
            }

        #fileList ul {
            list-style-type: none;
            padding-left: 1em;
            margin: 0;
        }

        #fileList li {
            margin: 0.2em 0;
        }
    </style>
</head>
<body>
    <div id="header">
        <button onclick="showPage('index')">Index</button>
        <button onclick="showPage('dashboard')">Dashboard</button>
        <button onclick="showPage('edit')">Edit</button>
        <button onclick="storageClear()">ã‚¯ãƒªã‚¢</button>
        <button id="loginButton" onclick="redirectLogin()">Googleã§ãƒ­ã‚°ã‚¤ãƒ³</button>
        <button id="modeSwitchBtn" style="display:none;" onclick="toggleMode()"></button>
    </div>

    <!-- Index Page -->
    <div id="page-index" class="page active">
        <h2>ğŸ“ Google Drive ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ</h2>

        <input type="text" id="projectName" placeholder="ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’å…¥åŠ›" /><br><br>
        <button onclick="listFolders()">ğŸ“‚ è¦ªãƒ•ã‚©ãƒ«ãƒ€é¸æŠ</button>
        <div id="folderList">(ãƒ•ã‚©ãƒ«ãƒ€ä¸€è¦§ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™)</div><br>
        <button onclick="startProjectCreation()">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ</button>
        <pre id="log">(ã“ã“ã«ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™)</pre>
    </div>
    <!-- Dashboard Page -->
    <div id="page-dashboard" class="page">
        <h2>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå†…å®¹</h2>
        <select id="projectSelect" onchange="selectProject(this.value)">
            <option value="">-- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠ --</option>
        </select>
        <button onclick="listProjects()">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ã‚’å–å¾—</button>

        <div id="dashboardLayout">
            <!-- å·¦ã‚«ãƒ©ãƒ ï¼šãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ æœ¨ -->
            <div id="projectTreePanel">
                <h3>ğŸ“‚ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ </h3>
                <div id="projectTreeContainer">(æ§‹é€ æœ¨ã‚’æ§‹ç¯‰ä¸­...)</div>
            </div>

            <!-- å³ã‚«ãƒ©ãƒ ï¼šãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆ -->
            <div id="fileListPanel">
                <h3>ğŸ“„ ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§</h3>
                <button onclick="createMemo()">ğŸ“ ãƒ¡ãƒ¢æ–°è¦ä½œæˆ</button>
                <div id="dropZone">ã“ã“ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ï¼ˆã¾ãŸã¯ä¸‹ã®ãƒœã‚¿ãƒ³ã§é¸æŠï¼‰</div>
                <input type="file" id="filePicker" multiple style="margin-top:10px;" />
                <ul id="filePreview"></ul>
                <button onclick="uploadAll()">å®Œäº†ã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
                <div id="fileList">(èª­ã¿è¾¼ã¿ä¸­...)</div>
            </div>
        </div>

        <div id="filePreviewModal" style="display:none; border:1px solid #888; padding:10px; margin-top:20px;">
            <button onclick="closePreview()" style="float:right;">Ã—</button>
            <div id="previewContent">(ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™)</div>
        </div>
    </div>
    <div id="page-edit" class="page">
        <h2>âœï¸ ç·¨é›†</h2>
        <!-- ã‚¿ãƒ–ãƒ˜ãƒƒãƒ€ -->
        <div id="editTabs" class="tab-header">
            <!-- ä¾‹: <button class="tab active" data-id="fileId">ãƒ•ã‚¡ã‚¤ãƒ«å Ã—</button> -->
        </div>

        <!-- ã‚¿ãƒ–ã”ã¨ã®ç·¨é›†ãƒ“ãƒ¥ãƒ¼ -->
        <div id="editContents" class="tab-contents">
            <!-- ä¾‹: <div class="editorPane active" data-id="fileId">...</div> -->
        </div>
    </div>


    <script>
        // ======== å…±é€šéƒ¨åˆ† ==========
        //ãƒ–ãƒ©ã‚¦ã‚¶ã€ãƒ­ãƒ¼ã‚«ãƒ«é–“ã®åˆ‡ã‚Šæ›¿ãˆ
        function isElectron() {
            return !!(window.electronAPI && window.electronAPI.isElectron);
        }

        function initModeButton() {
            const btn = document.getElementById('modeSwitchBtn');
            if (!isElectron()) return; // Electronä»¥å¤–ã§ã¯éè¡¨ç¤º
            btn.style.display = 'inline-block';
            if (window.location.pathname.endsWith('local.html')) {
                btn.textContent = 'ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã‚‹';
            } else {
                btn.textContent = 'ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã‚‹';
            }
        }

        function toggleMode() {
            if (window.location.pathname.endsWith('local.html')) {
                // local.html -> app.html
                window.location.href = 'app.html';
            } else {
                // app.html -> local.html
                window.location.href = 'local.html';
            }
        }
        async function findParentMapJson(folderId, pathStack = []) {
            if (!isLogin()) return;
            const token = getToken();
            if (!folderId || !rootNyuunId) return null;
            //pathStack.unshift("/");
            // 1. ç¾åœ¨ã®ãƒ•ã‚©ãƒ«ãƒ€ã§ map.json ã‚’æ¤œç´¢
            const query = encodeURIComponent(`'${folderId}' in parents and name = 'map.json' and trashed = false`);
            const res = await fetch(`https://www.googleapis.com/drive/v3/files?q=${query}&fields=files(id,name,parents)`, {
                headers: { Authorization: `Bearer ${token}` }
            });
            const data = await res.json();
            if (data.files.length > 0)
                return {
                    parentMapId: data.files[0].id,
                    path: pathStack
                };
            const folderRes = await fetch(
                `https://www.googleapis.com/drive/v3/files/${folderId}?fields=id,name,parents`,
                { headers: { Authorization: `Bearer ${token}` } }
            );
            const folderData = await folderRes.json();

            if (!folderData.parents || folderData.parents.length === 0) return null;

            const parentId = folderData.parents[0];
            if (parentId === rootNyuunId) return null; // nyu--nã«åˆ°é”ã—ãŸã‚‰çµ‚äº†
            pathStack.unshift(folderData.name);

            return await findParentMapJson(parentId, pathStack);
        }
        async function updateParentMapWithProject(parentMapId, projectInfo) {
            const res = await fetch(`https://www.googleapis.com/drive/v3/files/${parentMapId}?alt=media`, {
                headers: { Authorization: `Bearer ${getToken()}` }
            });
            const parentMap = await res.json();
            parentMap.files.push(projectInfo);
            await saveSpecificMap(parentMap, parentMapId);
        }

        async function saveSpecificMap(map, fileId) {
            const form = new FormData();
            form.append("metadata", new Blob([JSON.stringify({ name: "map.json", mimeType: "application/json" })], { type: "application/json" }));
            form.append("file", new Blob([JSON.stringify(map, null, 2)], { type: "application/json" }));
            await fetch(`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=multipart`, {
                method: "PATCH", headers: { Authorization: `Bearer ${getToken()}` }, body: form
            });
        }
        // ======== ãƒšãƒ¼ã‚¸åˆ‡ã‚Šæ›¿ãˆ ==========
        function showPage(name) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(`page-${name}`).classList.add('active');
            //if (!token) return; unya
            if (!isLogin()) return;
            if (name === 'dashboard') {
                listProjects();
                displayFiles();
            }
        }
        function updatePreview() {
            const editor = document.getElementById("editor");
            const preview = document.getElementById("preview");
            preview.innerHTML = marked.parse(editor.value);
        }

        let currentEditFileId = null;

        // ======== Index éƒ¨åˆ† ==========
        function storageClear() {
            localStorage.clear();
            alert("LocalStorageã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ");
        }
        function updateLoginStatus() {
            const status = document.getElementById("loginButton");
            if (!status) return;
            const expiresAt = Number(localStorage.getItem("accessTokenExpiresAt") || "0");
            const now = Date.now();
            const isLoggedIn = expiresAt > now;
            status.textContent = isLoggedIn
                ? `âœ… ãƒ­ã‚°ã‚¤ãƒ³ä¸­ï¼ˆæ®‹ã‚Šç´„ ${Math.floor((expiresAt - now) / 60000)} åˆ†ï¼‰`
                : "âš ï¸ ãƒ­ã‚°ã‚¢ã‚¦ãƒˆçŠ¶æ…‹ï¼ˆå†ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ï¼‰";
            if (!isLoggedIn) {
                localStorage.removeItem("accessToken");
                localStorage.removeItem("accessTokenExpiresAt");
            }
        }
        updateLoginStatus();
        setInterval(updateLoginStatus, 60000);

        function isLogin() {
            const expiresAt = Number(localStorage.getItem("accessTokenExpiresAt") || "0");
            return expiresAt > Date.now();
        }
        function getToken() {
            return localStorage.getItem("accessToken");
        }

        const clientId = "295167116096-sva04gs0vtr6hvof2r1cfdtlqre4ohpb.apps.googleusercontent.com";
        const redirectUri = "https://chigaac.github.io/callback.html";
        const scope = "https://www.googleapis.com/auth/drive.file";

        let selectedParentId = null;
        const log = msg => document.getElementById("log").textContent += `\n${msg}`;
        async function redirectLogin() {
            if (isElectron()) {
                const token = await window.electronAPI.login();
                log("Electron token:", token);
                if (token) {
                    localStorage.setItem("accessToken", token);
                    const expiresAt = Date.now() + 3600 * 1000;
                    localStorage.setItem("accessTokenExpiresAt", expiresAt);
                    updateLoginStatus();
                    await listProjects(); // è¿½åŠ 
                    await displayFiles(); // è¿½åŠ 
                }
                return;
            }

            // Webç‰ˆãƒ•ãƒ­ãƒ¼
            const params = new URLSearchParams({
                client_id: clientId, redirect_uri: redirectUri, response_type: "token",
                scope: scope, include_granted_scopes: "true"
            });
            location.href = `https://accounts.google.com/o/oauth2/v2/auth?${params}`;
        }

        async function ensureNyuunFolder(token) {
            if (!token) return;
            const query = encodeURIComponent("name = 'nyu--n' and mimeType = 'application/vnd.google-apps.folder' and trashed = false");
            const res = await fetch(`https://www.googleapis.com/drive/v3/files?q=${query}&fields=files(id,name)`, {
                headers: { Authorization: `Bearer ${token}` }
            });
            const data = await res.json();
            if (data.files.length > 0) return data.files[0].id;
            const createRes = await fetch("https://www.googleapis.com/drive/v3/files", {
                method: "POST",
                headers: { Authorization: `Bearer ${tokne}`, "Content-Type": "application/json" },
                body: JSON.stringify({ name: "nyu--n", mimeType: "application/vnd.google-apps.folder" })
            });
            const created = await createRes.json();
            return created.id;
        }
        async function startProjectCreation() {
            const token = getToken();
            if (!token) return log("âŒ ãƒˆãƒ¼ã‚¯ãƒ³ãŒæœªå–å¾—ã§ã™");

            const projectName = document.getElementById("projectName").value.trim();
            if (!projectName) return log("âŒ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

            log(`ğŸ“Œ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ '${projectName}' ã‚’ä½œæˆã—ã¾ã™...`);

            let parentId = selectedParentId || await ensureNyuunFolder(token);
            if (selectedParentId) {
                log(`ğŸ“‚ é¸æŠã•ã‚ŒãŸè¦ªãƒ•ã‚©ãƒ«ãƒ€: ${selectedParentId}`);
            } else {
                log("ğŸ“‚ 'nyu--n' ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½¿ç”¨ã—ã¾ã™");
            }

            localStorage.setItem("pendingProjectName", projectName);
            localStorage.setItem("pendingParentId", parentId);

            const newMapId = await createProject(projectName, parentId, token);
            if (!newMapId) return;

            // è¦ªã® map.json ã«æ–°ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ç™»éŒ²
            if (selectedParentId) {
                //const parentMapId = await findParentMapJson(selectedParentId);
                const { parentMapId, path } = await findParentMapJson(selectedParentId);
                if (parentMapId) {
                    await updateParentMapWithProject(parentMapId, {
                        id: newMapId, // â˜…æ–°ã—ãä½œæˆã—ãŸå­ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã® map.json ID ã‚’ç™»éŒ²
                        name: projectName,
                        path: path,
                        as: "project",
                        created: new Date().toISOString()
                    });
                    log("ğŸ“Œ è¦ªã® map.json ã‚’æ›´æ–°ã—ã¾ã—ãŸ");
                } else {
                    log("â„¹ï¸ ä¸Šä½ map.json ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ");
                }
            }
        }
        let rootNyuunId = null;

        async function findNyuunRootId(token) {
            const query = encodeURIComponent("name = 'nyu--n' and mimeType = 'application/vnd.google-apps.folder' and trashed = false");
            const res = await fetch(`https://www.googleapis.com/drive/v3/files?q=${query}&fields=files(id,name)`, {
                headers: { Authorization: `Bearer ${token }` }
            });
            const data = await res.json();
            if (data.files.length > 0) {
                rootNyuunId = data.files[0].id;
            }
        }
        async function listFolders() {
            const token = getToken();
            if (!token) {
                log("âŒ ãƒˆãƒ¼ã‚¯ãƒ³ãŒæœªå–å¾—ã§ã™");
                return;
            }
            await findNyuunRootId(token);
            const res = await fetch("https://www.googleapis.com/drive/v3/files?q=mimeType='application/vnd.google-apps.folder' and trashed=false&fields=files(id,name)", {
                headers: { Authorization: `Bearer ${token }` }
            });
            const result = await res.json();
            const div = document.getElementById("folderList");
            div.innerHTML = "";
            result.files.forEach(f => {
                const btn = document.createElement("button");
                btn.textContent = f.name;
                btn.onclick = () => { selectedParentId = f.id; log(`ğŸ“Œ è¦ªãƒ•ã‚©ãƒ«ãƒ€é¸æŠ: ${f.name}`); };
                div.appendChild(btn);
                div.appendChild(document.createElement("br"));
            });
        }
        async function createProject(name, parentId, token) {
            log(`ğŸ“ '${name}' ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆä¸­...`);

            const projectId = await createFolder(name, parentId, token);
            log(`  â”” ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚©ãƒ«ãƒ€ä½œæˆ: ${projectId}`);

            const memoId = await createFolder("ãƒ¡ãƒ¢", projectId, token);
            const embedId = await createFolder("åŸ‹ã‚è¾¼ã¿ãƒ•ã‚¡ã‚¤ãƒ«", projectId, token);
            const dataId = await createFolder("ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿", projectId, token);

            const map = { projectName: name, folders: { memo: memoId, embed: embedId, data: dataId }, files: [] };
            const metadata = { name: "map.json", mimeType: "application/json", parents: [projectId] };

            const form = new FormData();
            form.append("metadata", new Blob([JSON.stringify(metadata)], { type: "application/json" }));
            form.append("file", new Blob([JSON.stringify(map, null, 2)], { type: "application/json" }));

            log("  â”” map.json ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...");
            const upload = await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart", {
                method: "POST", headers: { Authorization: `Bearer ${token}` }, body: form
            });

            if (upload.ok) {
                const mapInfo = await upload.json();
                log("âœ… ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆå®Œäº†");
                return mapInfo.id; // â˜…æ–°è¦ map.json ã® ID ã‚’è¿”ã™
            } else {
                log("âŒ map.json ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—");
                return null;
            }
        }

        async function createFolder(name, parentId, token) {
            const res = await fetch("https://www.googleapis.com/drive/v3/files", {
                method: "POST",
                headers: { Authorization: `Bearer ${token}`, "Content-Type": "application/json" },
                body: JSON.stringify({ name, mimeType: "application/vnd.google-apps.folder", parents: [parentId] })
            });
            return (await res.json()).id;
        }

        // ======== Dashboard éƒ¨åˆ† ==========
        let selectedProjectId = null;     // ã€ŒåŸºæº–ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã€ (ãƒ«ãƒ¼ãƒˆãƒ„ãƒªãƒ¼)
        let currentViewProjectId = null;  // ã€Œè¡¨ç¤ºä¸­ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã€ (å³ãƒšã‚¤ãƒ³ã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰)
        let projectTreeCache = {};        // mapId -> å–å¾—æ¸ˆã¿ map.json ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥

        async function fetchMapJsonById(mapId, token) {
            if (!mapId || !token) return null;
            const res = await fetch(`https://www.googleapis.com/drive/v3/files/${mapId}?alt=media`, {
                headers: { Authorization: `Bearer ${token}` }
            });
            return await res.json();
        }
        async function listProjects() {
            if (!isLogin()) {
                console.warn("tokenãŒæœªå–å¾—ã®ãŸã‚ listProjects() ã‚’ã‚¹ã‚­ãƒƒãƒ—");
                return;
            }
            const token = getToken();

            const res = await fetch(
                "https://www.googleapis.com/drive/v3/files?q=name='map.json' and trashed=false&fields=files(id,name,parents)",
                { headers: { Authorization: `Bearer ${token}` } }
            );
            const data = await res.json();
            const files = data.files || [];
            const select = document.getElementById("projectSelect");
            select.innerHTML = "<option value=''>-- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠ --</option>";
            for (const f of files) {
                let parentName = "(ä¸æ˜)";
                if (f.parents && f.parents.length > 0) {
                    const parentId = f.parents[0];
                    const parentRes = await fetch(`https://www.googleapis.com/drive/v3/files/${parentId}?fields=name`, {
                        headers: { Authorization: `Bearer ${token}` }
                    });
                    const parentData = await parentRes.json();
                    parentName = parentData.name;
                }
                const option = document.createElement("option");
                option.value = f.id;
                option.textContent = parentName;
                if (f.id === selectedProjectId) option.selected = true;
                select.appendChild(option);
            }
        }
        async function selectProject(id) {
            if (!id) return;

            // é¸æŠã•ã‚ŒãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ selectedProjectId ã«åæ˜ 
            selectedProjectId = id;
            currentViewProjectId = id; // è¡¨ç¤ºãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚‚é¸æŠã•ã‚ŒãŸã‚‚ã®ã«æ›´æ–°
            await updateLeftPanel();
            await updateRightPanel();
        }
        async function updateLeftPanel() {
            if (!selectedProjectId) {
                document.getElementById("projectTreeContainer").textContent = "âŒ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“";
                return;
            }
            await renderProjectTree(); // selectedProjectIdã«åŸºã¥ã„ã¦å·¦ãƒ„ãƒªãƒ¼æ›´æ–°
        }
        async function updateRightPanel() {
            if (!currentViewProjectId) {
                document.getElementById("fileList").textContent = "âŒ è¡¨ç¤ºãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“";
                return;
            }
            await displayFiles(currentViewProjectId); // currentViewProjectIdã«åŸºã¥ã„ã¦å³ãƒªã‚¹ãƒˆæ›´æ–°
        }
        const projectTrees = {};

        async function getProjectData(projectId,token) {
            if (!projectTrees[projectId]) {
                const map = await fetchMapJsonById(projectId,token);
                projectTrees[projectId] = {
                    map,
                    projectTree: null,
                    fileTree: null
                };
            }
            return projectTrees[projectId];
        }
        async function buildProjectTree(projectId,token) {
            // ã“ã“ã§ getProjectData() ã‚’å‘¼ã³å‡ºã™
            const projectData = await getProjectData(projectId,token);
            const prevTree = projectData.projectTree?.find(c => c.id === file.id);

            const map = projectData.map;

            const root = {
                id: projectId,
                name: map.projectName || "æœªå‘½åãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ",
                type: "project",
                isOpen: prevTree?.isOpen ?? true,
                children: []
            };

            for (const file of map.files || []) {
                if (file.as === "project") {
                    const prevChild = prevTree?.children?.find(c => c.id === file.id);
                    const childTree = await buildProjectTree(file.id,token);
                    root.children.push(childTree);
                }
            }

            return root;
        }

        function renderProjectTreeNode(node) {
            const li = document.createElement("li");

            const toggle = document.createElement("span");
            toggle.textContent = node.isOpen ? "âˆ¨" : "ï¼";
            toggle.style.cursor = "pointer";
            toggle.style.marginRight = "5px";
            toggle.onclick = () => {
                node.isOpen = !node.isOpen;
                toggle.textContent = node.isOpen ? "âˆ¨" : "ï¼";
                childContainer.style.display = node.isOpen ? "block" : "none";
            };

            const label = document.createElement("span");
            label.textContent = `ğŸ“ ${node.name}`;
            label.style.cursor = "pointer";
            label.onclick = () => {
                currentViewProjectId = node.id;
                updateRightPanel();
            };

            const childContainer = document.createElement("ul");
            childContainer.style.display = node.isOpen ? "block" : "none";
            node.children.forEach(child => childContainer.appendChild(renderProjectTreeNode(child)));

            li.appendChild(toggle);
            li.appendChild(label);
            li.appendChild(childContainer);

            return li;
        }

        async function renderProjectTree() {
            if (!selectedProjectId) {
                document.getElementById("projectTreeContainer").textContent = "âŒ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“";
                return;
            }
            const token = getToken();

            const tree = await buildProjectTree(selectedProjectId,token);

            const container = document.getElementById("projectTreeContainer");
            container.innerHTML = "";
            container.appendChild(renderProjectTreeNode(tree));
        }

        function renderFileTreeNode(node, parentPath = "",token) {
            const li = document.createElement("li");
            const label = document.createElement("span");

            // ç·¨é›†ãƒœã‚¿ãƒ³ï¼ˆâœï¸ï¼‰
            const editBtn = document.createElement("button");
            editBtn.textContent = "âœï¸";
            editBtn.style.marginLeft = "8px";
            editBtn.onclick = (e) => {
                e.stopPropagation(); // ãƒ•ã‚¡ã‚¤ãƒ«/ãƒ•ã‚©ãƒ«ãƒ€é–‹é–‰ã‚¤ãƒ™ãƒ³ãƒˆã‚’é˜»æ­¢
                openEditTab(node);    // æ–°è¦ã‚¿ãƒ–ä½œæˆ & Editãƒšãƒ¼ã‚¸ã¸
            };

            if (node.type === "folder" || node.type === "project") {
                label.textContent =
                    node.type === "project"
                        ? `ğŸ‘¾ ${node.name} (Project)`
                        : `ğŸ“ ${node.name} (${node.children.length})`;

                const toggle = document.createElement("span");
                toggle.style.cursor = "pointer";
                toggle.style.marginRight = "5px";
                toggle.textContent = node.isOpen ? "âˆ¨" : "ï¼";
                const childContainer = document.createElement("ul");
                childContainer.style.display = node.isOpen ? "block" : "none";

                toggle.onclick = async () => {
                    node.isOpen = !node.isOpen;
                    toggle.textContent = node.isOpen ? "âˆ¨" : "ï¼";
                    childContainer.style.display = node.isOpen ? "block" : "none";

                    // ã‚µãƒ–ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’åˆå›å±•é–‹
                    if (node.type === "project" && node.isOpen) {
                        if (!fileTrees[node.id]) {
                            const subMap = await fetchMapJsonById(node.id, token);
                            fileTrees[node.id] = buildFileTree(subMap);
                        }
                        node.children = fileTrees[node.id].children;

                        childContainer.innerHTML = "";
                        node.children.forEach(child =>
                            childContainer.appendChild(renderFileTreeNode(child, `${parentPath}/${node.name}`,token))
                        );
                    }
                };

                li.appendChild(toggle);
                li.appendChild(label);
                li.appendChild(editBtn); // âœï¸ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
                li.appendChild(childContainer);

                node.children.forEach(child =>
                    childContainer.appendChild(renderFileTreeNode(child, `${parentPath}/${node.name}`,token))
                );
            } else {
                label.textContent = `ğŸ“„ ${node.name}`;
                li.style.cursor = "pointer";

                li.onclick = () => {
                    showPreview(node);
                };

                li.appendChild(label);
                li.appendChild(editBtn); // âœï¸ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
            }

            return li;
        }

        function renderFileTree(tree,token) {
            const container = document.getElementById("fileList");
            container.innerHTML = "";

            const ul = document.createElement("ul");
            tree.children.forEach(child => ul.appendChild(renderFileTreeNode(child,"",token)));
            container.appendChild(ul);
        }
        // --- å³ãƒ‘ãƒãƒ«ç”¨ãƒ„ãƒªãƒ¼ã‚­ãƒ£ãƒƒã‚·ãƒ¥ ---
        const fileTrees = {};  // projectId -> fileTree

        function buildFileTree(map, prevTree = null) {
            const root = prevTree || { name: "(root)", type: "folder", isOpen: true, children: [] };
            root.children = [];  // ãƒ•ãƒ«ãƒªã‚»ãƒƒãƒˆã—ã¦å·®ã—æ›¿ãˆ

            const topFolders = ["ãƒ¡ãƒ¢", "åŸ‹ã‚è¾¼ã¿ãƒ•ã‚¡ã‚¤ãƒ«", "ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿"];
            for (const folderName of topFolders) {
                const prevNode = prevTree?.children?.find(c => c.name === folderName && c.type === "folder");
                root.children.push({
                    name: folderName,
                    type: "folder",
                    isOpen: prevNode?.isOpen ?? true,
                    children: []
                });
            }

            addFilesToTree(root, map.files || [], prevTree);
            return root;
        }

        function addFilesToTree(parent, files, prevParent = null) {
            for (const file of files) {
                const pathParts = Array.isArray(file.path) ? file.path : (file.path ? [file.path] : []);
                let currentNode = parent;
                let prevNode = prevParent;

                for (const part of pathParts) {
                    let folderNode = currentNode.children.find(c => c.name === part && c.type === "folder");
                    let prevFolder = prevNode?.children?.find(c => c.name === part && c.type === "folder");

                    if (!folderNode) {
                        folderNode = {
                            name: part,
                            type: "folder",
                            isOpen: prevFolder?.isOpen ?? false,
                            children: []
                        };
                        currentNode.children.push(folderNode);
                    }

                    currentNode = folderNode;
                    prevNode = prevFolder;
                }

                const existing = currentNode.children.find(c => c.name === file.name && c.type !== "folder");
                if (!existing) {
                    const prevFileNode = prevNode?.children?.find(c => c.name === file.name);
                    currentNode.children.push({
                        ...file,
                        name: file.name,
                        type: file.as === "project" ? "project" : (file.as || "file"),
                        isOpen: prevFileNode?.isOpen ?? false,
                        children: []
                    });
                }
            }
        }
        async function addFiles(mapId = currentViewProjectId, newFiles) {
            const token = getToken();
            if (fileTrees[mapId]) {
                addFilesToTree(fileTrees[mapId], newFiles);
                renderFileTree(fileTrees[mapId],token);
            } else {
                // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒã¾ã ãªã„å ´åˆã¯åˆæœŸåŒ–
                fileTrees[mapId] = buildFileTree(map);
                renderFileTree(fileTrees[mapId],token);
            }
        }
        async function displayFiles(mapId = currentViewProjectId) {
            if (!mapId) return;
            const token = getToken();
            if (!fileTrees[mapId]) {
                const map = await fetchMapJsonById(mapId, token);
                fileTrees[mapId] = buildFileTree(map);
            }
            renderFileTree(fileTrees[mapId],token);
        }

        async function initDashboard() {
            if (!selectedProjectId) {
                console.warn("selectedProjectId ãŒæœªè¨­å®šã§ã™");
                return;
            }
            const token = getToken();
            renderProjectTree(token);
        }

        const previewCache = {};       // { fileId: { html, blobUrl, size } }
        const previewCacheOrder = [];
        const MAX_CACHE_ITEMS = 20;
        let previewCacheTotalSize = 0;  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥åˆè¨ˆã‚µã‚¤ã‚ºï¼ˆbytesï¼‰

        async function showPreview(file) {
            const modal = document.getElementById("filePreviewModal");
            const content = document.getElementById("previewContent");
            //content.innerHTML = "èª­ã¿è¾¼ã¿ä¸­...";

            const alwaysFetch = (file.name === "map.json");
            const token = getToken();

            // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å–å¾—
            const fileMetaRes = await fetch(
                `https://www.googleapis.com/drive/v3/files/${file.id}?fields=mimeType,size`,
                { headers: { Authorization: `Bearer ${token}` } }
            );
            const fileMeta = await fileMetaRes.json();
            const mimeType = fileMeta.mimeType || "application/octet-stream";

            // --- ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒã‚ã‚Œã°å†åˆ©ç”¨ ---
            if (!alwaysFetch && previewCache[file.id]) {
                console.log(`ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚µã‚¤ã‚º: ${previewCache[file.id].size} bytes`);
                debugPreviewCache();

                // --- ã‚­ãƒ£ãƒƒã‚·ãƒ¥é †åºã‚’æ›´æ–°ï¼ˆå…ˆé ­ã«ç§»å‹•ï¼‰ ---
                const index = previewCacheOrder.indexOf(file.id);
                if (index !== -1) {
                    previewCacheOrder.splice(index, 1);  // æ—¢å­˜ä½ç½®ã‚’å‰Šé™¤
                    previewCacheOrder.unshift(file.id);  // å…ˆé ­ã«è¿½åŠ 
                }

                content.innerHTML = previewCache[file.id].html;
                modal.style.display = "block";
                return;
            }

            let html = "";

            // --- ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ« ---
            if (mimeType.startsWith("text/") || mimeType === "application/json" || mimeType.includes("markdown")) {
                const textRes = await fetch(`https://www.googleapis.com/drive/v3/files/${file.id}?alt=media`, {
                    headers: { Authorization: `Bearer ${token}` }
                });
                const textContent = await textRes.text();
                const previewText =
                    textContent.length > 2000
                        ? textContent.slice(0, 2000) + "\n\n...ï¼ˆç¶šãã¯çœç•¥ï¼‰"
                        : textContent;
                html = `<pre style="white-space:pre-wrap; max-height:300px; overflow:auto;">${escapeHtml(previewText)}</pre>`;

                if (!alwaysFetch) addPreviewCache(file.id, html, null, textContent.length);

                content.innerHTML = html;
                modal.style.display = "block";
                return;
            }

            // --- ç”»åƒãƒ»éŸ³å£°ãƒ»å‹•ç”» ---
            const blobRes = await fetch(`https://www.googleapis.com/drive/v3/files/${file.id}?alt=media`, {
                headers: { Authorization: `Bearer ${token}` }
            });
            const blob = await blobRes.blob();
            const blobUrl = URL.createObjectURL(blob);

            if (mimeType.startsWith("image/")) {
                html = `<img src="${blobUrl}" style="max-width:100%; max-height:300px;">`;
            } else if (mimeType.startsWith("audio/")) {
                html = `<audio controls src="${blobUrl}" style="width:100%;"></audio>`;
            } else if (mimeType.startsWith("video/")) {
                html = `<video controls src="${blobUrl}" style="width:100%; max-height:300px;"></video>`;
            } else {
                html = `<p>ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ã‚¤ãƒ—ã¯ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚</p>`;
            }

            if (!alwaysFetch) addPreviewCache(file.id, html, blobUrl, blob.size);

            console.log(`å–å¾—ã‚µã‚¤ã‚º: ${blob.size} bytes`);
            debugPreviewCache();
            content.innerHTML = html;
            modal.style.display = "block";
        }
        function addPreviewCache(fileId, html, blobUrl, size) {
            // æ—¢å­˜ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒã‚ã‚‹å ´åˆã¯ã€ã‚µã‚¤ã‚ºã‚’æ¸›ç®—ã—ã¦å¤ã„Blob URLã‚’è§£æ”¾
            if (previewCache[fileId]) {
                previewCacheTotalSize -= (previewCache[fileId].size || 0);
                if (previewCache[fileId].blobUrl) URL.revokeObjectURL(previewCache[fileId].blobUrl);
                previewCacheOrder.splice(previewCacheOrder.indexOf(fileId), 1);
            }

            // æ–°è¦ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç™»éŒ²
            previewCache[fileId] = { html, blobUrl, size };
            previewCacheOrder.unshift(fileId); // å…ˆé ­ã«è¿½åŠ ï¼ˆLRUå¯¾å¿œï¼‰

            // ã‚µã‚¤ã‚ºåŠ ç®—
            previewCacheTotalSize += (size || 0);

            // æœ€å¤§ä»¶æ•°ã‚’è¶…ãˆãŸå ´åˆã€å¤ã„ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å‰Šé™¤
            while (previewCacheOrder.length > MAX_CACHE_ITEMS) {
                const oldId = previewCacheOrder.pop();
                if (previewCache[oldId]) {
                    previewCacheTotalSize -= (previewCache[oldId].size || 0);
                    if (previewCache[oldId].blobUrl) URL.revokeObjectURL(previewCache[oldId].blobUrl);
                    delete previewCache[oldId];
                }
            }

            console.log(`ç¾åœ¨ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥åˆè¨ˆã‚µã‚¤ã‚º: ${previewCacheTotalSize} bytes`);
        }

        function debugPreviewCache() {
            const table = Object.entries(previewCache).map(([id, entry]) => ({
                fileId: id,
                size: entry.size ? `${entry.size} bytes` : "-",
                hasBlobUrl: !!entry.blobUrl
            }));
            console.table(table);
            console.log("ã‚­ãƒ£ãƒƒã‚·ãƒ¥é †åº:", previewCacheOrder);
            console.log(`ã‚­ãƒ£ãƒƒã‚·ãƒ¥åˆè¨ˆã‚µã‚¤ã‚º: ${previewCacheTotalSize} bytes`);
        }

        // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ï¼ˆãƒ†ã‚­ã‚¹ãƒˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§HTMLã‚¿ã‚°ã‚’ç„¡åŠ¹åŒ–ã™ã‚‹ãŸã‚ï¼‰
        function escapeHtml(text) {
            return text.replace(/[&<>"']/g, function (m) {
                return {
                    "&": "&amp;",
                    "<": "&lt;",
                    ">": "&gt;",
                    '"': "&quot;",
                    "'": "&#39;"
                }[m];
            });
        }

        function closePreview() {
            document.getElementById("filePreviewModal").style.display = "none";
        }
        async function createMemo() {
            if (!currentViewProjectId) {
                alert("âŒ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
                return;
            }

            // map.json ã‚’å–å¾—
            const map = await fetchMapJsonById(currentViewProjectId);
            const fileName = `æ–°è¦ãƒ¡ãƒ¢_${Date.now()}.md`;
            const metadata = { name: fileName, mimeType: "text/markdown", parents: [map.folders.memo] };

            // ç©ºã®ãƒ¡ãƒ¢ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
            const form = new FormData();
            form.append("metadata", new Blob([JSON.stringify(metadata)], { type: "application/json" }));
            form.append("file", new Blob([""], { type: "text/markdown" }));

            const res = await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart", {
                method: "POST",
                headers: { Authorization: `Bearer ${getToken()}` },
                body: form
            });
            if (!res.ok) {
                alert("âŒ ãƒ¡ãƒ¢ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ");
                return;
            }

            // æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«ã®æƒ…å ±ã‚’å–å¾—
            const newFile = await res.json();
            const fileEntry = {
                id: newFile.id,
                name: fileName,
                path: ["ãƒ¡ãƒ¢"],
                as: "memo",
                created: new Date().toISOString()
            };

            // map.json ã«è¿½åŠ 
            map.files.push(fileEntry);
            await saveMap(map);

            // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ„ãƒªãƒ¼ã«åæ˜ 
            addFiles(currentViewProjectId, [fileEntry]);

            // ã‚¿ãƒ–ã‚’é–‹ã
            openEditTab(fileEntry);
        }

        async function saveMap(map, id = currentViewProjectId) {
            if (!id) { alert("âŒ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"); return; }
            const form = new FormData();
            form.append(
                "metadata",
                new Blob(
                    [JSON.stringify({ name: "map.json", mimeType: "application/json" })],
                    { type: "application/json" }
                )
            );
            form.append(
                "file",
                new Blob([JSON.stringify(map, null, 2)], { type: "application/json" })
            );

            await fetch(`https://www.googleapis.com/upload/drive/v3/files/${id}?uploadType=multipart`, {
                method: "PATCH",
                headers: { Authorization: `Bearer ${getToken()}` },
                body: form
            });
        }


        // --- ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç† ---
        let pendingFiles = [];
        const dropZone = document.getElementById("dropZone");
        const filePicker = document.getElementById("filePicker");
        const filePreview = document.getElementById("filePreview");

        dropZone.addEventListener("dragover", e => {
            e.preventDefault();
            dropZone.style.background = "#eef";
        });
        dropZone.addEventListener("dragleave", () => dropZone.style.background = "");
        dropZone.addEventListener("drop", e => {
            e.preventDefault();
            dropZone.style.background = "";
            pendingFiles.push(...Array.from(e.dataTransfer.files));
            refreshPreview();
        });
        filePicker.addEventListener("change", e => {
            pendingFiles.push(...Array.from(e.target.files));
            refreshPreview();
            filePicker.value = "";
        });

        function refreshPreview() {
            filePreview.innerHTML = "";
            pendingFiles.forEach((file, index) => {
                const li = document.createElement("li");
                const nameSpan = document.createElement("span");
                nameSpan.textContent = `${file.name} (${Math.round(file.size / 1024)} KB) `;
                li.appendChild(nameSpan);

                const preview = document.createElement("span");
                preview.style.margin = "0 10px";
                preview.style.display = "inline-block";

                if (file.type.startsWith("image/")) {
                    const img = document.createElement("img");
                    img.style.maxWidth = "80px";
                    img.style.maxHeight = "60px";
                    img.style.objectFit = "cover";
                    const reader = new FileReader();
                    reader.onload = e => (img.src = e.target.result);
                    reader.readAsDataURL(file);
                    preview.appendChild(img);
                } else if (file.type.startsWith("video/")) {
                    preview.textContent = "ğŸï¸";
                } else if (file.type.startsWith("audio/")) {
                    preview.textContent = "ğŸµ";
                } else if (file.type.startsWith("text/") || file.type === "application/json") {
                    const reader = new FileReader();
                    reader.onload = e => {
                        const content = e.target.result.slice(0, 20).replace(/\n/g, " ");
                        preview.textContent = `ğŸ“ ${content}${content.length >= 20 ? "..." : ""}`;
                    };
                    reader.readAsText(file);
                } else {
                    preview.textContent = "ğŸ“„";
                }
                li.appendChild(preview);

                const delBtn = document.createElement("button");
                delBtn.textContent = "å‰Šé™¤";
                delBtn.onclick = () => {
                    pendingFiles.splice(index, 1);
                    refreshPreview();
                };
                li.appendChild(delBtn);

                filePreview.appendChild(li);
            });
        }
        async function uploadAll() {
            if (!currentViewProjectId) {
                alert("âŒ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
                return;
            }
            if (pendingFiles.length === 0) {
                alert("ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“");
                return;
            }
            const token = getToken();

            // map.json ã‚’å–å¾—
            const map = await fetchMapJsonById(currentViewProjectId, token);
            const uploadRoot = map.folders.data;

            // æ–°ã—ã„ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆ
            const now = new Date();
            const folderName = now.toISOString().replace(/[-:]/g, "").slice(0, 15).replace("T", "_");
            const folderId = await createFolder(folderName, uploadRoot, token);

            // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é †æ¬¡ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
            const newFiles = [];
            for (const file of pendingFiles) {
                const newFile = await uploadFileToFolder(file, folderId, token);

                // map.json ã«è¿½è¨˜
                const fileEntry = {
                    id: newFile.id,
                    name: file.name,
                    path: ["ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿", folderName],
                    as: "embed",  // å›ºå®šã§ embed
                    created: new Date().toISOString()
                };
                map.files.push(fileEntry);
                newFiles.push(fileEntry);
            }

            // map.json ã‚’ä¿å­˜
            await saveMap(map);

            addFiles(currentViewProjectId, newFiles);

            // UIæ›´æ–°
            alert("âœ… ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†ï¼");
            pendingFiles = [];
            refreshPreview();
        }

        async function uploadFileToFolder(file, parentId, token) {
            const metadata = { name: file.name, parents: [parentId] };
            const form = new FormData();
            form.append("metadata", new Blob([JSON.stringify(metadata)], { type: "application/json" }));
            form.append("file", file);
            const res = await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart", {
                method: "POST",
                headers: { Authorization: `Bearer ${token}` },
                body: form
            });
            return await res.json(); // idå–å¾—ã®ãŸã‚ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™
        }
        // ======== Edit éƒ¨åˆ† ==========
        const editor = document.getElementById("editor");
        const preview = document.getElementById("preview");

        function openEditTab(file) {
            // æ—¢ã«ã‚¿ãƒ–ãŒã‚ã‚‹ã‹ç¢ºèª
            const existingTab = document.querySelector(`#editTabs .tab[data-id="${file.id}"]`);
            if (existingTab) {
                setActiveTab(file.id);
                showPage('edit');
                return;
            }

            // ã‚¿ãƒ–ä½œæˆ
            const tabBtn = document.createElement("button");
            tabBtn.className = "tab";
            tabBtn.dataset.id = file.id;
            tabBtn.textContent = file.name;

            // Ã—ãƒœã‚¿ãƒ³
            const closeBtn = document.createElement("span");
            closeBtn.textContent = " Ã—";
            closeBtn.onclick = e => { e.stopPropagation(); closeTab(file.id); };
            tabBtn.appendChild(closeBtn);

            tabBtn.onclick = () => setActiveTab(file.id);
            document.getElementById("editTabs").appendChild(tabBtn);

            // ã‚¨ãƒ‡ã‚£ã‚¿ãƒ“ãƒ¥ãƒ¼ä½œæˆ
            const content = document.createElement("div");
            content.className = "editorPane";
            content.dataset.id = file.id;
            document.getElementById("editContents").appendChild(content);

            // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ã‚¤ãƒ—åˆ¥UI
            createEditView(content, file);

            setActiveTab(file.id);
            showPage('edit');
        }
        async function loadFileContent(fileId, textarea, preview) {
            try {
                // ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹ã‚’å–å¾—
                const res = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {
                    headers: { Authorization: `Bearer ${token}` }
                });
                if (!res.ok) {
                    textarea.value = "";
                    preview.innerHTML = "<p>âŒ ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>";
                    return;
                }
                const text = await res.text();
                textarea.value = text;

                // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°ï¼ˆMarkdownå¯¾å¿œï¼‰
                const updatePreview = () => {
                    preview.innerHTML = marked.parse(textarea.value);
                };
                textarea.addEventListener("input", updatePreview);
                updatePreview();  // åˆæœŸè¡¨ç¤º
            } catch (e) {
                console.error("loadFileContent error:", e);
                textarea.value = "";
                preview.innerHTML = "<p>âŒ èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</p>";
            }
        }

        function createEditView(container, file) {
            // ãƒ•ã‚¡ã‚¤ãƒ«åå¤‰æ›´UI
            const nameInput = document.createElement("input");
            nameInput.value = file.name;
            const renameBtn = document.createElement("button");
            renameBtn.textContent = "åå‰ã‚’ä¿å­˜";
            renameBtn.onclick = () => renameFile(file.id, nameInput.value);
            container.appendChild(nameInput);
            container.appendChild(renameBtn);
            const saveBtn = document.createElement("button");
            saveBtn.textContent = "å†…å®¹ã‚’ä¿å­˜";
            saveBtn.onclick = () => saveFile(file.id, textarea.value);
            container.appendChild(saveBtn);

            // å†…å®¹ç·¨é›†UI
            if (file.as === "memo" || file.mimeType?.includes("markdown") || file.mimeType?.startsWith("text/")) {
                const textarea = document.createElement("textarea");
                container.appendChild(textarea);

                const preview = document.createElement("div");
                container.appendChild(preview);

                // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ­ãƒ¼ãƒ‰
                loadFileContent(file.id, textarea, preview);

                // ä¿å­˜ãƒœã‚¿ãƒ³
                const saveBtn = document.createElement("button");
                saveBtn.textContent = "å†…å®¹ã‚’ä¿å­˜";
                saveBtn.onclick = () => saveFile(file.id, textarea.value);
                container.appendChild(saveBtn);
            } else if (file.mimeType?.startsWith("image/") || file.mimeType?.startsWith("video/")) {
                const preview = document.createElement(file.mimeType.startsWith("image/") ? "img" : "video");
                preview.controls = file.mimeType.startsWith("video/");
                preview.style.maxWidth = "100%";
                container.appendChild(preview);
                loadPreviewFile(file.id, preview);
            } else if (file.type === "folder") {
                const note = document.createElement("p");
                note.textContent = "ãƒ•ã‚©ãƒ«ãƒ€ã¯åå‰å¤‰æ›´ã®ã¿å¯èƒ½ã§ã™ã€‚";
                container.appendChild(note);
            }
        }
        function setActiveTab(tabId) {
            document.querySelectorAll("#editTabs .tab").forEach(tab =>
                tab.classList.toggle("active", tab.dataset.id === tabId)
            );
            document.querySelectorAll("#editContents .editorPane").forEach(pane =>
                pane.classList.toggle("active", pane.dataset.id === tabId)
            );
        }
        function closeTab(tabId) {
            const tabBtn = document.querySelector(`#editTabs .tab[data-id="${tabId}"]`);
            const content = document.querySelector(`#editContents .editorPane[data-id="${tabId}"]`);
            if (tabBtn) tabBtn.remove();
            if (content) content.remove();
            // ä»–ã®ã‚¿ãƒ–ãŒã‚ã‚Œã°æœ€åˆã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–
            const firstTab = document.querySelector("#editTabs .tab");
            if (firstTab) setActiveTab(firstTab.dataset.id);
        }
        async function renameFile(fileId, newName) {
            // Google Drive å´
            await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}`, {
                method: "PATCH",
                headers: { Authorization: `Bearer ${getToken()}`, "Content-Type": "application/json" },
                body: JSON.stringify({ name: newName })
            });

            // map.json å´
            const map = await fetchMapJsonById(currentViewProjectId);
            const target = map.files.find(f => f.id === fileId);
            if (target) target.name = newName;
            await saveMap(map);

            alert("âœ… åå‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸ");
        }
        async function saveFile(fileId, content) {
            try {
                const res = await fetch(`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`, {
                    method: "PATCH",
                    headers: { Authorization: `Bearer ${getToken()}` },
                    body: content
                });

                if (!res.ok) {
                    alert("âŒ ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ");
                    console.error(await res.text());
                    return;
                }
                alert("âœ… ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼");
            } catch (e) {
                console.error("saveFile error:", e);
                alert("âŒ ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
            }
        }

        initDashboard();
        initModeButton();
        // åˆæœŸåŒ–
        listProjects();
        displayFiles();
    </script>
</body>
</html>
